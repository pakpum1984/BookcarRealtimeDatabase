<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองรถยนต์</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --dark: #1C1C1E;
            --light: #F2F2F7;
            --gray: #8E8E93;
            --card-bg: #FFFFFF;
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --accent: #5856D6;
            --gradient-start: #007AFF;
            --gradient-end: #5856D6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Prompt", sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--light), #E6E6EB);
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        body.loading {
            opacity: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .container.loaded {
            opacity: 1;
        }

        header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 12px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 1.5rem;
            color: white;
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-approve {
            background: var(--secondary);
            color: white;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
        }

        /* Calendar Styles */
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 16px;
        }

        .calendar {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--light);
            font-weight: 500;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .calendar-weekdays div {
            padding: 10px;
            text-align: center;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--gray);
            font-size: 0.85rem;
        }

        .calendar-weekdays div:last-child {
            border-right: none;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            padding: 10px 6px;
            min-height: 80px;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background-color: rgba(0, 122, 255, 0.08);
            transform: scale(1.02);
        }

        .calendar-day.other-month {
            color: #C7C7CC;
            background-color: #FAFAFC;
        }

        .calendar-day.has-booking {
            background-color: rgba(52, 199, 89, 0.08);
        }

        .calendar-day.selected {
            background-color: rgba(0, 122, 255, 0.12);
            border: 2px solid var(--primary);
        }

        .calendar-day.today {
            background-color: rgba(255, 149, 0, 0.12);
            border: 2px solid var(--warning);
        }

        .calendar-day.disabled {
            background-color: #F0F0F0;
            color: #C7C7CC;
            cursor: not-allowed;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .booking-indicator {
            font-size: 0.65rem;
            color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            margin-top: 4px;
            display: inline-block;
            font-weight: 500;
        }

        /* Sidebar Styles */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .booking-summary {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-title i {
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(15px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--light);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Action Menu Styles */
        .action-menu {
            position: absolute;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            padding: 6px;
            z-index: 100;
            min-width: 140px;
            display: none;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(15px);
        }

        .action-menu.active {
            display: block;
            animation: modalAppear 0.2s ease;
        }

        .action-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .action-item:hover {
            background: var(--light);
        }

        .action-item.book {
            color: var(--primary);
        }

        .action-item.view {
            color: var(--secondary);
        }

        /* Login Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 32px;
            width: 100%;
            max-width: 380px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .login-title {
            text-align: center;
            margin-bottom: 24px;
            color: var(--dark);
            font-size: 1.4rem;
            font-weight: 600;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
            color: var(--primary);
            font-size: 2.5rem;
        }

        /* Loading Styles */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 122, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Styles */
        .alert {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .alert-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Status Badge */
        .status-badge {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Booking List Styles */
        .booking-list {
            max-height: 360px;
            overflow-y: auto;
        }

        .booking-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--light);
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .booking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .booking-item.pending {
            border-left-color: var(--warning);
        }

        .booking-item.approved {
            border-left-color: var(--secondary);
        }

        .booking-item.rejected {
            border-left-color: var(--danger);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .booking-actions {
            display: flex;
            gap: 6px;
        }

        .booking-details {
            font-size: 0.8rem;
            color: var(--dark);
            line-height: 1.5;
        }

        /* My Bookings Styles */
        .my-bookings-list {
            max-height: 280px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .my-booking-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: var(--light);
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .my-booking-item:hover {
            transform: translateY(-1px);
        }

        .my-booking-item.pending {
            border-left-color: var(--warning);
        }

        .my-booking-item.approved {
            border-left-color: var(--secondary);
        }

        .my-booking-item.rejected {
            border-left-color: var(--danger);
        }

        /* Radio and Checkbox Styles */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #C7C7CC;
            border-radius: 50%;
            margin-right: 6px;
            position: relative;
            cursor: pointer;
        }

        input[type="radio"]:checked {
            border-color: var(--primary);
        }

        input[type="radio"]:checked::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Bottom Navigation for Mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.08);
            z-index: 100;
            padding: 8px 0;
        }

        .bottom-nav ul {
            display: flex;
            justify-content: space-around;
            list-style: none;
        }

        .bottom-nav li {
            text-align: center;
        }

        .bottom-nav a {
            color: var(--gray);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }

        .bottom-nav a.active {
            color: var(--primary);
        }

        .bottom-nav i {
            font-size: 1.3rem;
            margin-bottom: 3px;
        }

        /* Admin Management Styles */
        .admin-management {
            max-width: 800px;
            margin: 0 auto;
        }

        .tab-nav {
            display: flex;
            background: var(--light);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .tab-content.active {
            display: block;
        }

        .management-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--light);
        }

        .management-item-info {
            flex: 1;
        }

        .management-actions {
            display: flex;
            gap: 8px;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .calendar-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: row;
                gap: 10px;
                padding: 8px 16px;
            }

            .logo h1 {
                font-size: 1rem;
            }

            .user-info {
                gap: 8px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .calendar-header {
                flex-direction: row;
                gap: 10px;
                padding: 12px;
            }

            .calendar-day {
                min-height: 70px;
                padding: 8px 3px;
            }

            .bottom-nav {
                display: block;
            }

            .container {
                padding-bottom: 60px;
            }

            .user-info button {
                display: none;
            }

            .management-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 576px) {

            
            .container {
                padding: 12px;
            }

            .card {
                padding: 12px;
            }

            .calendar-weekdays div {
                padding: 6px 2px;
                font-size: 0.75rem;
            }

            .calendar-day {
                min-height: 60px;
                padding: 6px 2px;
            }

            .day-number {
                font-size: 0.75rem;
            }

            .booking-indicator {
                font-size: 0.55rem;
            }
        }

                /* เพิ่มสไตล์สำหรับโหลดดิ้ง */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            font-size: 3rem;
            color: white;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ปรับปรุง responsive styles สำหรับปุ่มแอดมินในมือถือ */
        @media (max-width: 768px) {
            .admin-btn-desktop {
                display: none !important;
            }
            
            .admin-nav-mobile {
                display: block !important;
            }
        }

        @media (min-width: 769px) {
            .admin-btn-desktop {
                display: inline-block !important;
            }
            
            .admin-nav-mobile {
                display: none !important;
            }
        }
    </style>
</head>
<body class="loading">
    <!-- เพิ่มหน้าจอโหลดดิ้ง -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-car"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">กำลังโหลดระบบจองรถยนต์...</div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">เข้าสู่ระบบ</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="login-logo">
                    <i class="fas fa-car"></i>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="email">อีเมล</label>
                        <input type="email" id="email" class="form-control" placeholder="กรอกอีเมล" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">รหัสผ่าน</label>
                        <input type="password" id="password" class="form-control" placeholder="กรอกรหัสผ่าน" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">เข้าสู่ระบบ</button>
                    </div>
                </form>
                <div style="margin-top: 20px; padding: 16px; background: var(--light); border-radius: 12px;">
                    <h4 style="margin-bottom: 12px; color: var(--dark);">บัญชีทดสอบ:</h4>
               
                    <p style="margin-bottom: 8px; font-size: 0.9rem;"><strong>ผู้ใช้ทั่วไป:</strong> parweenar@email.com / 622001</p>
                    <p style="font-size: 0.9rem;"><strong>ผู้ดูแลระบบ:</strong> adminbookcarcm2@email.com / adminbookcarcm2</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="bookingModalTitle">จองรถยนต์</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookingId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="startDate">วันที่ออก</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="endDate">วันที่เข้า</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="bookerName">ชื่อผู้จอง</label>
                            <input type="text" id="bookerName" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="department">แผนก</label>
                            <input type="text" id="department" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">วัตถุประสงค์</label>
                        <div>
                            <input type="radio" id="purposeNormal" name="purpose" value="normal" checked>
                            <label for="purposeNormal">ปกติ</label>
                            <input type="radio" id="purposeLeaveWork" name="purpose" value="leaveWork" style="margin-left: 15px;">
                            <label for="purposeLeaveWork">ฝากงาน</label>
                            <input type="radio" id="purposeCarToWork" name="purpose" value="carToWork" style="margin-left: 15px;">
                            <label for="purposeCarToWork">ติดรถไปติดต่องาน</label>
                        </div>
                    </div>
                    <div class="form-group" id="carSelectGroup" style="display: none;">
                        <label class="form-label" for="carSelect">เลือกรถ</label>
                        <select id="carSelect" class="form-control">
                            <option value="">-- เลือกรถ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">สถานะการขับ</label>
                        <div>
                            <input type="radio" id="selfDrive" name="driverStatus" value="self" checked>
                            <label for="selfDrive">ขับเอง</label>
                            <input type="radio" id="withDriver" name="driverStatus" value="with" style="margin-left: 15px;">
                            <label for="withDriver">พร้อมคนขับ</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="startTime">เวลาออก</label>
                            <input type="time" id="startTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="endTime">เวลาเข้า</label>
                            <input type="time" id="endTime" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="destination">สถานที่ไปติดต่อ</label>
                        <input type="text" id="destination" class="form-control" placeholder="กรอกสถานที่ไปติดต่อ" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="notes">อื่นๆ</label>
                        <textarea id="notes" class="form-control" rows="3" placeholder="หมายเหตุเพิ่มเติม"></textarea>
                    </div>
                    <div id="adminControls" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">สถานะการอนุมัติ</label>
                            <div>
                                <input type="radio" id="statusPending" name="approvalStatus" value="pending">
                                <label for="statusPending">รออนุมัติ</label>
                                <input type="radio" id="statusApproved" name="approvalStatus" value="approved" style="margin-left: 15px;">
                                <label for="statusApproved">อนุมัติ</label>
                                <input type="radio" id="statusRejected" name="approvalStatus" value="rejected" style="margin-left: 15px;">
                                <label for="statusRejected">ปฏิเสธ</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelBooking">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveBooking" style="color: var(--light); background-color: var(--primary);" >บันทึกการจอง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Bookings Modal -->
    <div class="modal" id="viewBookingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="viewBookingsModalTitle">การจองทั้งหมด</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="viewBookingsDate" style="margin-bottom: 20px; font-weight: bold;"></div>
                <div class="booking-list" id="bookingsList">
                    <!-- Bookings will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- My Bookings Modal -->
    <div class="modal" id="myBookingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">การจองทั้งหมดของฉัน</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="booking-list" id="myBookingsList">
                    <!-- My bookings will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Management Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title">จัดการข้อมูลระบบ</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="cars">จัดการรถยนต์</button>
                    <button class="tab-btn" data-tab="users">จัดการผู้ใช้</button>
                </div>
                <div class="tab-content active" id="carsTab">
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" id="addCarBtn">เพิ่มรถใหม่</button>
                    </div>
                    <div class="management-list" id="carsList">
                        <!-- Cars will be listed here -->
                    </div>
                </div>
                <div class="tab-content" id="usersTab">
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" id="addUserBtn">เพิ่มผู้ใช้ใหม่</button>
                    </div>
                    <div class="management-list" id="usersList">
                        <!-- Users will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Car Form Modal -->
    <div class="modal" id="carFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="carFormTitle">เพิ่มรถใหม่</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="carForm">
                    <input type="hidden" id="carId">
                    <div class="form-group">
                        <label class="form-label" for="carBrand">ยี่ห้อ</label>
                        <input type="text" id="carBrand" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carColor">สี</label>
                        <input type="text" id="carColor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carFuelType">ประเภทน้ำมัน</label>
                        <select id="carFuelType" class="form-control" required>
                            <option value="gasoline">เบนซิน</option>
                            <option value="diesel">ดีเซล</option>
                            <option value="electric">ไฟฟ้า</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carImageUrl">URL รูปภาพ</label>
                        <input type="url" id="carImageUrl" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carLastMaintenance">วันที่บำรุงรักษาล่าสุด</label>
                        <input type="date" id="carLastMaintenance" class="form-control">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelCarForm">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Form Modal -->
    <div class="modal" id="userFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userFormTitle">เพิ่มผู้ใช้ใหม่</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userUid">
                    <div class="form-group">
                        <label class="form-label" for="userEmail">อีเมล</label>
                        <input type="email" id="userEmail" class="form-control" required>
                    </div>
                    <div class="form-group" id="userPasswordGroup">
                        <label class="form-label" for="userPassword">รหัสผ่าน</label>
                        <input type="password" id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userDisplayName">ชื่อ-นามสกุล</label>
                        <input type="text" id="userDisplayName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userDepartment">แผนก</label>
                        <input type="text" id="userDepartment" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userRole">บทบาท</label>
                        <select id="userRole" class="form-control" required>
                            <option value="user">ผู้ใช้ทั่วไป</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelUserForm">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Action Menu -->
    <div class="action-menu" id="actionMenu">
        <div class="action-item book" id="bookAction">
            <i class="fas fa-calendar-plus"></i>
            <span>จองรถ</span>
        </div>
        <div class="action-item view" id="viewAction">
            <i class="fas fa-eye"></i>
            <span>ดูการจองทั้งหมด</span>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-car"></i>
                        <h1>ระบบจองรถยนต์</h1>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">ผู้ใช้</span>
                        <button class="btn btn-secondary" id="logoutBtn">ออกจากระบบ</button>
                        <button class="btn btn-warning" id="adminBtn" style="display: none;">จัดการข้อมูล</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>กำลังโหลดข้อมูล...</p>
            </div>

            <div id="mainContent" style="display: none;">
                <div class="alert alert-success" id="successAlert" style="display: none;">
                    การดำเนินการสำเร็จ
                </div>

                <div class="calendar-container">
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <h2 id="currentMonth">มกราคม 2023</h2>
                            <button class="btn btn-primary" id="newBookingBtn">จองรถ</button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>อาทิตย์</div>
                            <div>จันทร์</div>
                            <div>อังคาร</div>
                            <div>พุธ</div>
                            <div>พฤหัสบดี</div>
                            <div>ศุกร์</div>
                            <div>เสาร์</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Calendar days will be generated by JavaScript -->
                        </div>
                    </div>

                    <div class="sidebar">
                        <div class="booking-summary card">
                            <h3 class="summary-title">
                                <i class="fas fa-list"></i>
                                คิวการจองของท่านวันนี้
                            </h3>
                            <div id="myTodayBookings">
                                <!-- My today bookings will be listed here -->
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-primary btn-sm" id="viewAllMyBookingsBtn">
                                    <i class="fas fa-history"></i>
                                    ดูการจองทั้งหมดของฉัน
                                </button>
                            </div>
                        </div>
                    </div><br>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav" id="bottomNav">
        <ul id="bottomNavUl">
            <li>
                <a href="#" id="homeNav" class="active">
                    <i class="fas fa-calendar"></i>
                    <span>ปฏิทิน</span>
                </a>
            </li>
            <li>
                <a href="#" id="bookingsNav">
                    <i class="fas fa-list"></i>
                    <span>การจองของฉัน</span>
                </a>
            </li>
            <li id="adminNavLi" style="display: none;">
                <a href="#" id="adminNav">
                    <i class="fas fa-cog"></i>
                    <span>จัดการ</span>
                </a>
            </li>
            <li>
                <a href="#" id="logoutNav">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ออกจากระบบ</span>
                </a>
            </li>
        </ul>
    </nav>

    <script>
    // Firebase Configuration
    const firebaseConfig = {
  apiKey: "AIzaSyAFZGvjTZDiimtyyauEaRY5UeajLlMVKEA",
  authDomain: "dataequipment-8a4e5.firebaseapp.com",
  databaseURL: "https://dataequipment-8a4e5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dataequipment-8a4e5",
  storageBucket: "dataequipment-8a4e5.firebasestorage.app",
  messagingSenderId: "1016960943788",
  appId: "1:1016960943788:web:ed8837e802aaf9f5e3c109",
  measurementId: "G-XDF8SSH478"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ตัวแปรสถานะแอปพลิเคชัน
    let currentUser = null;
    let currentDate = new Date();
    let selectedDate = null;
    let selectedBooking = null;
    let cars = [];
    let users = [];
    let bookings = [];




    

    // DOM Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const loginModal = document.getElementById('loginModal');
    const bookingModal = document.getElementById('bookingModal');
    const viewBookingsModal = document.getElementById('viewBookingsModal');
    const myBookingsModal = document.getElementById('myBookingsModal');
    const adminModal = document.getElementById('adminModal');
    const carFormModal = document.getElementById('carFormModal');
    const userFormModal = document.getElementById('userFormModal');
    const loginForm = document.getElementById('loginForm');
    const bookingForm = document.getElementById('bookingForm');
    const carForm = document.getElementById('carForm');
    const userForm = document.getElementById('userForm');
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthElement = document.getElementById('currentMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const newBookingBtn = document.getElementById('newBookingBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminBtn = document.getElementById('adminBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const mainContent = document.getElementById('mainContent');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const successAlert = document.getElementById('successAlert');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const bookerNameInput = document.getElementById('bookerName');
    const departmentInput = document.getElementById('department');
    const carSelect = document.getElementById('carSelect');
    const carSelectGroup = document.getElementById('carSelectGroup');
    const bookingIdInput = document.getElementById('bookingId');
    const bookingModalTitle = document.getElementById('bookingModalTitle');
    const saveBookingBtn = document.getElementById('saveBooking');
    const adminControls = document.getElementById('adminControls');
    const actionMenu = document.getElementById('actionMenu');
    const bookAction = document.getElementById('bookAction');
    const viewAction = document.getElementById('viewAction');
    const bookingsList = document.getElementById('bookingsList');
    const viewBookingsDate = document.getElementById('viewBookingsDate');
    const myTodayBookings = document.getElementById('myTodayBookings');
    const viewAllMyBookingsBtn = document.getElementById('viewAllMyBookingsBtn');
    const myBookingsList = document.getElementById('myBookingsList');
    const carsList = document.getElementById('carsList');
    const usersList = document.getElementById('usersList');
    

    // Bottom Nav Elements
    const homeNav = document.getElementById('homeNav');
    const bookingsNav = document.getElementById('bookingsNav');
    const logoutNav = document.getElementById('logoutNav');
    const adminNavLi = document.getElementById('adminNavLi');
    const adminNav = document.getElementById('adminNav');
    const bottomNavUl = document.getElementById('bottomNavUl');

    function initApp() {
        // แสดง loading screen
        loadingScreen.classList.remove('hidden');
        
        // แสดง loading และซ่อน container
        document.body.classList.add('loading');
        loadingIndicator.style.display = 'flex';
        mainContent.style.display = 'none';
        document.querySelectorAll('.container').forEach(c => c.classList.remove('loaded'));

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                // Force fetch user data ทุกครั้ง เพื่อความเสถียร
                database.ref('users/' + currentUser.uid).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        console.log('Fetched user data:', userData); // Debug log (ลบได้)
                        if (userData) {
                            currentUser.displayName = userData.displayName || currentUser.email.split('@')[0];
                            currentUser.department = userData.department || 'ไม่ระบุ'; // ยืนยัน set department
                            currentUser.role = userData.role || 'user';
                        } else {
                            // ถ้าไม่มีข้อมูลผู้ใช้ในฐานข้อมูล ให้สร้างข้อมูลใหม่
                            const username = currentUser.email.split('@')[0];
                            const displayName = username.charAt(0).toUpperCase() + username.slice(1) + ' User';
                            
                            database.ref('users/' + currentUser.uid).set({
                                displayName: displayName,
                                department: 'ไม่ระบุ',
                                role: 'user',
                                email: currentUser.email,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            });
                            
                            currentUser.displayName = displayName;
                            currentUser.department = 'ไม่ระบุ';
                            currentUser.role = 'user';
                        }
                        // Force reload global users ถ้าเป็น admin
                        if (currentUser.role === 'admin') {
                            loadUsers();
                        }
                        showMainApp();
                        loadCars();
                        loadBookings();
                    })
                    .catch((error) => {
                        console.error('Error fetching user data:', error);
                        showSweetAlert('ไม่สามารถดึงข้อมูลผู้ใช้ได้: ' + error.message, 'error');
                    });
            } else {
                showLoginModal();
                // ซ่อน loading screen หลังจาก auth ตรวจสอบแล้ว
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    document.body.classList.remove('loading');
                    loadingIndicator.style.display = 'none';
                    document.querySelectorAll('.container').forEach(c => c.classList.add('loaded'));
                }, 500);
            }
        });

        // Set min date for booking inputs
        const today = formatDate(new Date());
        startDateInput.setAttribute('min', today);
        endDateInput.setAttribute('min', today);

        addEventListeners();
    }

function showMainApp() {
    // ซ่อน loading screen
    loadingScreen.classList.add('hidden');
    
    loadingIndicator.style.display = 'none';
    mainContent.style.display = 'block';
    document.body.classList.remove('loading');
    document.querySelectorAll('.container').forEach(c => c.classList.add('loaded'));
    loadCalendar();

    // อัพเดตข้อมูลผู้ใช้ในฟังก์ชันนี้ด้วย
    updateUserDisplay();
}

function updateUserDisplay() {
    if (currentUser && currentUser.displayName) {
        // ใช้ displayName จาก currentUser ที่โหลดมาแล้ว
        const displayName = currentUser.displayName;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
        userName.textContent = displayName;

        if (currentUser.role === 'admin') {
            adminControls.style.display = 'block';
            adminBtn.style.display = 'inline-block';
            // แสดง bottom nav สำหรับ admin
            adminNavLi.style.display = 'block';
            // ปรับ layout bottom nav ถ้ามี admin menu
            const liCount = bottomNavUl.children.length;
            bottomNavUl.style.justifyContent = liCount > 3 ? 'space-around' : 'space-around';
            
            // เพิ่มคลาสเพื่อจัดการการแสดงผลในมือถือ
            adminBtn.classList.add('admin-btn-desktop');
            adminNavLi.classList.add('admin-nav-mobile');
        } else {
            adminNavLi.style.display = 'none';
            adminBtn.style.display = 'none';
        }
    } else {
        // ถ้ายังไม่มีข้อมูลผู้ใช้ ให้แสดงข้อมูลพื้นฐาน
        const emailName = currentUser ? currentUser.email.split('@')[0] : 'ผู้ใช้';
        userAvatar.textContent = emailName.charAt(0).toUpperCase();
        userName.textContent = emailName;
    }
}

    function addEventListeners() {
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', () => {
                loginModal.classList.remove('active');
                bookingModal.classList.remove('active');
                viewBookingsModal.classList.remove('active');
                myBookingsModal.classList.remove('active');
                adminModal.classList.remove('active');
                carFormModal.classList.remove('active');
                userFormModal.classList.remove('active');
            });
        });

        // Tab navigation for admin
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            });
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            loadCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            loadCalendar();
        });

        newBookingBtn.addEventListener('click', () => {
            showBookingModal();
        });

        adminBtn.addEventListener('click', () => {
            if (currentUser.role === 'admin') {
                adminModal.classList.add('active');
                loadCarsList();
                if (users.length === 0) {
                    database.ref('users').once('value').then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            users = Object.keys(data).map(key => ({
                                uid: key,
                                ...data[key]
                            }));
                        }
                        loadUsersList();
                    });
                } else {
                    loadUsersList();
                }
            } else {
                showSweetAlert('คุณไม่มีสิทธิ์เข้าถึง', 'error');
            }
        });

        logoutBtn.addEventListener('click', logout);
        loginForm.addEventListener('submit', handleLogin);
        bookingForm.addEventListener('submit', handleBooking);
        carForm.addEventListener('submit', handleCarForm);
        userForm.addEventListener('submit', handleUserForm);
        document.getElementById('cancelBooking').addEventListener('click', () => {
            bookingModal.classList.remove('active');
            resetBookingForm();
        });
        document.getElementById('cancelCarForm').addEventListener('click', () => {
            carFormModal.classList.remove('active');
            resetCarForm();
        });
        document.getElementById('cancelUserForm').addEventListener('click', () => {
            userFormModal.classList.remove('active');
            resetUserForm();
        });
        document.getElementById('addCarBtn').addEventListener('click', () => showCarFormModal());
        document.getElementById('addUserBtn').addEventListener('click', () => showUserFormModal());
        viewAllMyBookingsBtn.addEventListener('click', showMyBookingsModal);
        bookAction.addEventListener('click', () => {
            actionMenu.classList.remove('active');
            showBookingModal(selectedDate);
        });
        viewAction.addEventListener('click', () => {
            actionMenu.classList.remove('active');
            showViewBookingsModal(selectedDate);
        });
        document.querySelectorAll('input[name="purpose"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'normal') {
                    carSelectGroup.style.display = 'block';
                    carSelect.setAttribute('required', 'required');
                } else {
                    carSelectGroup.style.display = 'none';
                    carSelect.removeAttribute('required');
                    carSelect.value = '';
                }
            });
        });
        document.addEventListener('click', (e) => {
            if (!actionMenu.contains(e.target)) {
                actionMenu.classList.remove('active');
            }
        });
        homeNav.addEventListener('click', (e) => {
            e.preventDefault();
        });
        bookingsNav.addEventListener('click', (e) => {
            e.preventDefault();
            showMyBookingsModal();
        });
        logoutNav.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
        adminNav.addEventListener('click', (e) => {
            e.preventDefault();
            adminBtn.click();
        });
    }

    function showLoginModal() {
        loginModal.classList.add('active');
    }

function showBookingModal(selectedDay = null, bookingToEdit = null) {
    if (cars.length === 0) {
        showSweetAlert('กำลังโหลดข้อมูลรถยนต์ กรุณารอสักครู่', 'warning');
        return;
    }

    resetBookingForm();

    if (bookingToEdit) {
        // โหมดแก้ไขการจอง (ไม่เปลี่ยนแปลง)
        bookingModalTitle.textContent = "แก้ไขการจองรถยนต์";
        saveBookingBtn.textContent = "อัพเดตการจอง";
        bookingIdInput.value = bookingToEdit.id;
        
        // เติมข้อมูลในฟอร์ม
        startDateInput.value = bookingToEdit.startDate;
        endDateInput.value = bookingToEdit.endDate;
        bookerNameInput.value = bookingToEdit.bookerName;
        departmentInput.value = bookingToEdit.department;
        
        // ตั้งค่าวัตถุประสงค์
        document.querySelector(`input[name="purpose"][value="${bookingToEdit.purpose}"]`).checked = true;
        if (bookingToEdit.purpose === 'normal') {
            carSelectGroup.style.display = 'block';
            carSelect.value = bookingToEdit.carId;
        } else {
            carSelectGroup.style.display = 'none';
        }
        
        // ตั้งค่าสถานะการขับ
        document.querySelector(`input[name="driverStatus"][value="${bookingToEdit.driverStatus}"]`).checked = true;
        
        // ตั้งค่าเวลา
        document.getElementById('startTime').value = bookingToEdit.startTime;
        document.getElementById('endTime').value = bookingToEdit.endTime;
        document.getElementById('destination').value = bookingToEdit.destination;
        document.getElementById('notes').value = bookingToEdit.notes || '';
        
        // สำหรับแอดมิน: แสดงการควบคุมสถานะ
        if (currentUser.role === 'admin') {
            adminControls.style.display = 'block';
            document.querySelector(`input[name="approvalStatus"][value="${bookingToEdit.status}"]`).checked = true;
        }
    } else {
        // โหมดจองใหม่ - Force fetch ข้อมูล user จากฐานข้อมูลเพื่อให้แน่ใจ
        if (currentUser) {
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        bookerNameInput.value = userData.displayName || currentUser.email.split('@')[0]; // ดึงชื่อจริงก่อน
                        departmentInput.value = userData.department || 'ไม่ระบุ'; // แผนก (ซึ่งทำงานถูกต้องอยู่แล้ว)
                        console.log('Fetched user for booking form - Name:', bookerNameInput.value, 'Dept:', departmentInput.value); // Debug log (ลบได้หลังทดสอบ)
                    } else {
                        // Fallback ถ้าไม่มีข้อมูล (ไม่น่าจะเกิด)
                        bookerNameInput.value = currentUser.email.split('@')[0];
                        departmentInput.value = 'ไม่ระบุ';
                    }
                })
                .catch((error) => {
                    console.error('Error fetching user data for booking:', error);
                    showSweetAlert('ไม่สามารถดึงข้อมูลผู้ใช้ได้: ' + error.message, 'error');
                });
        }

        if (selectedDay) {
            const dateStr = formatDate(selectedDay);
            startDateInput.value = dateStr;
            endDateInput.value = dateStr;
        } else {
            const today = formatDate(new Date());
            startDateInput.value = today;
            endDateInput.value = today;
        }

        bookingModalTitle.textContent = "จองรถยนต์";
        saveBookingBtn.textContent = "บันทึกการจอง";
    }

    // เพิ่ม event listeners สำหรับ sync วันที่ (เฉพาะใน modal นี้)
    const handleDateChange = function() {
        if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
            endDateInput.value = startDateInput.value;
        }
        endDateInput.min = startDateInput.value;
    };

    const handleEndDateChange = function() {
        if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
            endDateInput.value = startDateInput.value;
        }
    };

    startDateInput.addEventListener('change', handleDateChange);
    endDateInput.addEventListener('change', handleEndDateChange);

    // ลบ listeners หลังปิด modal
    const removeListeners = () => {
        startDateInput.removeEventListener('change', handleDateChange);
        endDateInput.removeEventListener('change', handleEndDateChange);
    };

    // เรียกหลังปิด modal
    bookingModal.addEventListener('click', function closeHandler(e) {
        if (!bookingModal.contains(e.target) || e.target.classList.contains('close-modal')) {
            removeListeners();
            bookingModal.removeEventListener('click', closeHandler);
        }
    });
    
    bookingModal.classList.add('active');
}


function showViewBookingsModal(selectedDay) {
    const dateStr = formatDate(selectedDay);
    const dayBookings = bookings.filter(booking =>
        booking.startDate <= dateStr && booking.endDate >= dateStr
    ).sort((a, b) => new Date(b.startDate + 'T' + b.startTime) - new Date(a.startDate + 'T' + a.startTime));

    viewBookingsDate.textContent = `วันที่: ${formatThaiDate(selectedDay)} (การจองที่ครอบคลุมวันนี้)`;
    bookingsList.innerHTML = '';

    if (dayBookings.length === 0) {
        bookingsList.innerHTML = '<p>ไม่มีข้อมูลการจองในวันนี้</p>';
    } else {
        dayBookings.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `booking-item ${booking.status || 'pending'}`;

            const isAdmin = currentUser.role === 'admin';
            const isOwner = booking.userId === currentUser.uid;
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            
            // แก้ไขเงื่อนไข: แอดมินสามารถแก้ไขการจองที่รออนุมัติหรืออนุมัติแล้วได้
            const canEdit = !isPastDate && (
                (isAdmin && (isPending || isApproved)) || // แอดมินแก้ไขได้ทั้งที่รออนุมัติและอนุมัติแล้ว
                (isOwner && isPending) // ผู้ใช้แก้ไขได้เฉพาะที่รออนุมัติ
            );
            
            const canCancel = !isPastDate && (
                (isAdmin) || 
                (isOwner && (isPending || isApproved))
            );

            bookingItem.innerHTML = `
                <div class="booking-header">
                    <div>
                        <strong>${booking.bookerName}</strong> - ${getCarName(booking.carId)} (${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))})
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div class="booking-actions">
                        ${isAdmin && isPending ? `<button class="btn btn-sm btn-approve" onclick="approveBooking('${booking.id}')">อนุมัติ</button>` : ''}
                        ${isAdmin && isPending ? `<button class="btn btn-sm btn-reject" onclick="rejectBooking('${booking.id}')">ปฏิเสธ</button>` : ''}
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">แก้ไข</button>` : ''}
                        ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">ยกเลิก</button>` : ''}
                    </div>
                </div>
                <div class="booking-details">
                    <div>เวลา: ${booking.startTime} - ${booking.endTime}</div>
                    <div>จุดหมาย: ${booking.destination}</div>
                    <div>วัตถุประสงค์: ${getPurposeText(booking.purpose)}</div>
                    ${booking.notes ? `<div>หมายเหตุ: ${booking.notes}</div>` : ''}
                </div>
            `;
            bookingsList.appendChild(bookingItem);
        });
    }

    viewBookingsModal.classList.add('active');
}



    function editBooking(bookingId) {
        const booking = bookings.find(b => b.id === bookingId);
        if (booking) {
            showBookingModal(null, booking);
        }
    }

    function approveBooking(bookingId) {
        updateBookingStatus(bookingId, 'approved');
    }

    function rejectBooking(bookingId) {
        updateBookingStatus(bookingId, 'rejected');
    }

    function updateBookingStatus(bookingId, status) {
        database.ref('bookings/' + bookingId).update({ status: status })
            .then(() => {
                showSweetAlert(`การจองถูก${status === 'approved' ? 'อนุมัติ' : 'ปฏิเสธ'}แล้ว`, 'success');
                viewBookingsModal.classList.remove('active');
                updateMyTodayBookings(); // อัพเดตรายการทันที
            })
            .catch((error) => {
                showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
            });
    }

function showMyBookingsModal() {
    const myBookings = bookings.filter(booking => booking.userId === currentUser.uid)
        .sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

    myBookingsList.innerHTML = '';

    if (myBookings.length === 0) {
        myBookingsList.innerHTML = '<p>คุณยังไม่มีรายการจองรถ</p>';
    } else {
        myBookings.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `booking-item ${booking.status || 'pending'}`;

            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            
            // แก้ไขเงื่อนไข: แอดมินสามารถแก้ไขการจองที่รออนุมัติหรืออนุมัติแล้วได้
            const canEdit = !isPastDate && (
                (currentUser.role === 'admin' && (isPending || isApproved)) || // แอดมินแก้ไขได้ทั้งที่รออนุมัติและอนุมัติแล้ว
                (isPending) // ผู้ใช้แก้ไขได้เฉพาะที่รออนุมัติ
            );
            
            const canCancel = !isPastDate && (
                (currentUser.role === 'admin') || 
                (isPending || isApproved)
            );

            bookingItem.innerHTML = `
                <div class="booking-header">
                    <div>
                        <strong>${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))}</strong> - ${getCarName(booking.carId)}
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div class="booking-actions">
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">แก้ไข</button>` : ''}
                        ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">ยกเลิก</button>` : ''}
                    </div>
                </div>
                <div class="booking-details">
                    <div>เวลา: ${booking.startTime} - ${booking.endTime}</div>
                    <div>จุดหมาย: ${booking.destination}</div>
                    <div>วัตถุประสงค์: ${getPurposeText(booking.purpose)}</div>
                    ${booking.notes ? `<div>หมายเหตุ: ${booking.notes}</div>` : ''}
                </div>
            `;
            myBookingsList.appendChild(bookingItem);
        });
    }

    myBookingsModal.classList.add('active');
}




    function editCar(carId) {
        const car = cars.find(c => c.id === carId);
        if (car) {
            showCarFormModal(car);
        } else {
            showSweetAlert('ไม่พบข้อมูลรถ', 'error');
        }
    }

    function editUser(uid) {
        const user = users.find(u => u.uid === uid);
        if (user) {
            showUserFormModal(user);
        } else {
            showSweetAlert('ไม่พบข้อมูลผู้ใช้', 'error');
        }
    }

    function showCarFormModal(car = null) {
        resetCarForm();
        if (car) {
            document.getElementById('carFormTitle').textContent = 'แก้ไขรถ';
            document.getElementById('carId').value = car.id;
            document.getElementById('carBrand').value = car.brand || '';
            document.getElementById('carColor').value = car.color || '';
            document.getElementById('carFuelType').value = car.fuelType || 'gasoline';
            document.getElementById('carImageUrl').value = car.imageUrl || '';
            document.getElementById('carLastMaintenance').value = car.lastMaintenance ? new Date(car.lastMaintenance).toISOString().split('T')[0] : '';
        } else {
            document.getElementById('carFormTitle').textContent = 'เพิ่มรถใหม่';
            document.getElementById('carId').value = '';
        }
        carFormModal.classList.add('active');
    }

    function showUserFormModal(user = null) {
        resetUserForm();
        document.getElementById('userPasswordGroup').style.display = user ? 'none' : 'block';
        if (user) {
            document.getElementById('userFormTitle').textContent = 'แก้ไขผู้ใช้';
            document.getElementById('userUid').value = user.uid;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userDisplayName').value = user.displayName || '';
            document.getElementById('userDepartment').value = user.department || '';
            document.getElementById('userRole').value = user.role || 'user';
        } else {
            document.getElementById('userFormTitle').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('userUid').value = '';
        }
        userFormModal.classList.add('active');
    }

function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            return database.ref('users/' + currentUser.uid).once('value');
        })
        .then((snapshot) => {
            const userData = snapshot.val();
            console.log('Login fetched user data:', userData); // Debug log (ลบได้)
            if (userData) {
                currentUser.displayName = userData.displayName || currentUser.email.split('@')[0];
                currentUser.role = userData.role || 'user';
                currentUser.department = userData.department || 'ไม่ระบุ'; // ยืนยัน set department
            } else {
                // ถ้าไม่มีข้อมูลผู้ใช้ในฐานข้อมูล ให้สร้างข้อมูลใหม่
                const username = currentUser.email.split('@')[0];
                const displayName = username.charAt(0).toUpperCase() + username.slice(1) + ' User';
                
                return database.ref('users/' + currentUser.uid).set({
                    displayName: displayName,
                    department: 'ไม่ระบุ',
                    role: 'user',
                    email: currentUser.email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    currentUser.displayName = displayName;
                    currentUser.role = 'user';
                    currentUser.department = 'ไม่ระบุ';
                });
            }
        })
        .then(() => {
            loginModal.classList.remove('active');
            showMainApp();
            showSweetAlert('เข้าสู่ระบบสำเร็จ', 'success');
        })
        .catch((error) => {
            let errorMessage = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'ไม่พบบัญชีผู้ใช้';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'รหัสผ่านไม่ถูกต้อง';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
            }
            showSweetAlert(errorMessage, 'error');
        });
}











    function handleBooking(e) {
        e.preventDefault();

        const purposeInput = document.querySelector('input[name="purpose"]:checked');
        if (!purposeInput) {
            showSweetAlert('กรุณาเลือกวัตถุประสงค์', 'error');
            return;
        }
        const purpose = purposeInput.value;

        let carId = 'none';
        if (purpose === 'normal') {
            if (!carSelect || !carSelect.value) {
                showSweetAlert('กรุณาเลือกรถยนต์', 'error');
                return;
            }
            carId = carSelect.value;
        }

        if (!startDateInput || !startDateInput.value) {
            showSweetAlert('กรุณาเลือกวันที่ออก', 'error');
            return;
        }

        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const today = formatDate(new Date());
        if (new Date(startDate) < new Date(today)) {
            showSweetAlert('ไม่สามารถจองย้อนหลังได้', 'error');
            return;
        }

        if (new Date(endDate) < new Date(startDate)) {
            showSweetAlert('วันที่เข้าต้องไม่ก่อนวันที่ออก', 'error');
            return;
        }

        if (!document.getElementById('startTime') || !document.getElementById('startTime').value) {
            showSweetAlert('กรุณาเลือกเวลาเริ่มต้น', 'error');
            return;
        }

        if (!document.getElementById('endTime') || !document.getElementById('endTime').value) {
            showSweetAlert('กรุณาเลือกเวลาสิ้นสุด', 'error');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const bookingId = bookingIdInput.value || '';

        if (purpose === 'normal') {
            // เช็ค conflict สำหรับทุกวันระหว่าง startDate และ endDate
            const start = new Date(startDate);
            const end = new Date(endDate);
            let hasConflict = false;
            let currentDate = new Date(start);
            while (currentDate <= end) {
                const currentDateStr = formatDate(currentDate);
                const dayBookings = bookings.filter(booking =>
                    booking.id !== bookingId &&
                    booking.carId === carId &&
                    booking.status !== 'rejected' &&
                    (booking.startDate <= currentDateStr && booking.endDate >= currentDateStr) &&
                    ((startTime >= booking.startTime && startTime < booking.endTime) ||
                     (endTime > booking.startTime && endTime <= booking.endTime) ||
                     (startTime <= booking.startTime && endTime >= booking.endTime))
                );
                if (dayBookings.length > 0) {
                    hasConflict = true;
                    break;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (hasConflict) {
                showSweetAlert('รถคันนี้มีการจองในช่วงเวลานี้แล้ว', 'error');
                return;
            }
        }

        const bookingData = {
            startDate: startDate,
            endDate: endDate,
            bookerName: bookerNameInput.value,
            department: departmentInput.value,
            carId: carId,
            purpose: purpose,
            driverStatus: document.querySelector('input[name="driverStatus"]:checked')?.value || 'self',
            startTime: startTime,
            endTime: endTime,
            destination: document.getElementById('destination').value,
            notes: document.getElementById('notes').value,
            userId: currentUser.uid,
            status: currentUser.role === 'admin' ? (document.querySelector('input[name="approvalStatus"]:checked')?.value || 'approved') : 'pending'
        };

        if (bookingId) {
            updateBooking(bookingId, bookingData);
        } else {
            createBooking(bookingData);
        }
    }

    function createBooking(bookingData) {
        const newBookingRef = database.ref('bookings').push();
        bookingData.id = newBookingRef.key;
        bookingData.createdAt = firebase.database.ServerValue.TIMESTAMP;

        newBookingRef.set(bookingData)
            .then(() => {
                bookingModal.classList.remove('active');
                showSweetAlert('การจองรถสำเร็จ! รอการอนุมัติจากผู้ดูแลระบบ', 'success');
                resetBookingForm();
            })
            .catch((error) => {
                showSweetAlert('เกิดข้อผิดพลาดในการจอง: ' + error.message, 'error');
            });
    }

    function updateBooking(bookingId, bookingData) {
        database.ref('bookings/' + bookingId).update(bookingData)
            .then(() => {
                bookingModal.classList.remove('active');
                showSweetAlert('อัพเดตการจองสำเร็จ', 'success');
                resetBookingForm();
                updateMyTodayBookings(); // อัพเดตรายการทันที
            })
            .catch((error) => {
                showSweetAlert('เกิดข้อผิดพลาดในการอัพเดต: ' + error.message, 'error');
            });
    }

    function cancelBooking(bookingId) {
        const booking = bookings.find(b => b.id === bookingId);

        if (!booking) return;

        const isAdmin = currentUser.role === 'admin';
        const isOwner = booking.userId === currentUser.uid;
        const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));

        if (!isAdmin && !isOwner) {
            showSweetAlert('คุณไม่มีสิทธิ์ยกเลิกการจองนี้', 'error');
            return;
        }

        if (!isAdmin && isPastDate) {
            showSweetAlert('ไม่สามารถยกเลิกการจองย้อนหลังได้', 'error');
            return;
        }

        Swal.fire({
            title: 'คุณแน่ใจหรือไม่?',
            text: "คุณต้องการยกเลิกการจองนี้หรือไม่?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ยกเลิก!',
            cancelButtonText: 'ไม่, ยกเลิกการกระทำ'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('bookings/' + bookingId).remove()
                    .then(() => {
                        // ปิดหน้าต่างทั้งหมด
                        viewBookingsModal.classList.remove('active');
                        myBookingsModal.classList.remove('active');
                        showSweetAlert('ยกเลิกการจองสำเร็จ', 'success');
                        updateMyTodayBookings(); // อัพเดตรายการทันที
                    })
                    .catch((error) => {
                        showSweetAlert('เกิดข้อผิดพลาดในการยกเลิก: ' + error.message, 'error');
                    });
            }
        });
    }

    function handleCarForm(e) {
        e.preventDefault();
        const carId = document.getElementById('carId').value;
        const carData = {
            brand: document.getElementById('carBrand').value,
            color: document.getElementById('carColor').value,
            fuelType: document.getElementById('carFuelType').value,
            imageUrl: document.getElementById('carImageUrl').value,
            lastMaintenance: document.getElementById('carLastMaintenance').value ? new Date(document.getElementById('carLastMaintenance').value).toISOString() : null,
            createdAt: carId ? cars.find(c => c.id === carId).createdAt : firebase.database.ServerValue.TIMESTAMP
        };

        if (carId) {
            database.ref('cars/' + carId).update(carData)
                .then(() => {
                    showSweetAlert('อัพเดตรถสำเร็จ', 'success');
                    carFormModal.classList.remove('active');
                    loadCars();
                    loadCarsList();
                })
                .catch((error) => {
                    showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                });
        } else {
            const newCarRef = database.ref('cars').push();
            carData.id = newCarRef.key;
            newCarRef.set(carData)
                .then(() => {
                    showSweetAlert('เพิ่มรถสำเร็จ', 'success');
                    carFormModal.classList.remove('active');
                    loadCars();
                    loadCarsList();
                })
                .catch((error) => {
                    showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                });
        }
    }

    function handleUserForm(e) {
        e.preventDefault();
        const uid = document.getElementById('userUid').value;
        const isNewUser = !uid;
        const email = document.getElementById('userEmail').value;
        const password = document.getElementById('userPassword').value;
        const userData = {
            displayName: document.getElementById('userDisplayName').value,
            department: document.getElementById('userDepartment').value,
            role: document.getElementById('userRole').value,
            createdAt: isNewUser ? firebase.database.ServerValue.TIMESTAMP : users.find(u => u.uid === uid).createdAt,
            email: email
        };

        if (isNewUser) {
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const newUid = userCredential.user.uid;
                    userData.uid = newUid;
                    return database.ref('users/' + newUid).set(userData);
                })
                .then(() => {
                    showSweetAlert('เพิ่มผู้ใช้สำเร็จ', 'success');
                    userFormModal.classList.remove('active');
                    loadUsers();
                    loadUsersList();
                })
                .catch((error) => {
                    showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                });
        } else {
            database.ref('users/' + uid).update(userData)
                .then(() => {
                    showSweetAlert('อัพเดตผู้ใช้สำเร็จ', 'success');
                    userFormModal.classList.remove('active');
                    loadUsers();
                    loadUsersList();
                })
                .catch((error) => {
                    showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                });
        }
    }

    function deleteCar(carId) {
        Swal.fire({
            title: 'คุณแน่ใจหรือไม่?',
            text: "คุณต้องการลบรถนี้หรือไม่?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบ!',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('cars/' + carId).remove()
                    .then(() => {
                        showSweetAlert('ลบรถสำเร็จ', 'success');
                        loadCars();
                        loadCarsList();
                    })
                    .catch((error) => {
                        showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                    });
                }
        });
    }

    function deleteUser(uid) {
        Swal.fire({
            title: 'คุณแน่ใจหรือไม่?',
            text: "คุณต้องการลบผู้ใช้จากฐานข้อมูลหรือไม่? (บัญชี Firebase Auth จะยังคงอยู่ ต้องลบผ่าน Admin SDK)",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบ!',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('users/' + uid).remove()
                    .then(() => {
                        showSweetAlert('ลบผู้ใช้จากฐานข้อมูลสำเร็จ', 'success');
                        loadUsers();
                        loadUsersList();
                    })
                    .catch((error) => {
                        showSweetAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                    });
            }
        });
    }

    function loadCars() {
        database.ref('cars').on('value', (snapshot) => {
            const carsData = snapshot.val();
            if (carsData) {
                cars = Object.keys(carsData).map(key => ({
                    id: key,
                    ...carsData[key]
                }));
                updateCarSelect();
            } else {
                initializeCars();
            }
        });
    }

    function loadUsers() {
        database.ref('users').on('value', (snapshot) => {
            const usersData = snapshot.val();
            if (usersData) {
                users = Object.keys(usersData).map(key => ({
                    uid: key,
                    ...usersData[key]
                }));
            } else {
                users = [];
            }
            if (adminModal.classList.contains('active')) {
                loadUsersList();
            }
        });
    }

    function loadBookings() {
        database.ref('bookings').on('value', (snapshot) => {
            const bookingsData = snapshot.val();
            if (bookingsData) {
                bookings = Object.keys(bookingsData).map(key => ({
                    id: key,
                    ...bookingsData[key]
                }));
                loadCalendar();
                updateMyTodayBookings();
            }
        });
    }

    function loadCarsList() {
        carsList.innerHTML = '';
        cars.forEach(car => {
            const carItem = document.createElement('div');
            carItem.className = 'management-item';
            carItem.innerHTML = `
                <div class="management-item-info">
                    <strong>${car.brand || 'ไม่ระบุ'} (${car.color || 'ไม่ระบุ'})</strong>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        ID: ${car.id} | น้ำมัน: ${car.fuelType || 'ไม่ระบุ'} | ล่าสุด: ${car.lastMaintenance ? new Date(car.lastMaintenance).toLocaleDateString('th-TH') : 'ไม่ระบุ'}
                    </div>
                </div>
                <div class="management-actions">
                    <button class="btn btn-sm btn-primary" onclick="editCar('${car.id}')">แก้ไข</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCar('${car.id}')">ลบ</button>
                </div>
            `;
            carsList.appendChild(carItem);
        });
        if (cars.length === 0) {
            carsList.innerHTML = '<p style="text-align: center; color: var(--gray);">ไม่มีข้อมูลรถยนต์</p>';
        }
    }

    function loadUsersList() {
        usersList.innerHTML = '';
        
        // ตรวจสอบว่ามีข้อมูลผู้ใช้หรือไม่
        if (users.length === 0) {
            usersList.innerHTML = '<p style="text-align: center; color: var(--gray);">ไม่มีข้อมูลผู้ใช้</p>';
            return;
        }
        
        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'management-item';
            userItem.innerHTML = `
                <div class="management-item-info">
                    <strong>${user.displayName || 'ไม่ระบุ'} (${user.role === 'admin' ? 'แอดมิน' : 'ผู้ใช้'})</strong>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        อีเมล: ${user.email || 'ไม่ระบุ'} | แผนก: ${user.department || 'ไม่ระบุ'}
                    </div>
                </div>
                <div class="management-actions">
                    <button class="btn btn-sm btn-primary" onclick="editUser('${user.uid}')">แก้ไข</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.uid}')">ลบ</button>
                </div>
            `;
            usersList.appendChild(userItem);
        });
    }

    function initializeCars() {
        const defaultCars = [
            { brand: 'Toyota', color: 'ขาว', fuelType: 'gasoline', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Honda', color: 'ดำ', fuelType: 'gasoline', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Mazda', color: 'แดง', fuelType: 'diesel', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Ford', color: 'น้ำเงิน', fuelType: 'diesel', imageUrl: '', lastMaintenance: '2023-09-15' }
        ];

        defaultCars.forEach((car, index) => {
            const carId = 'car' + (index + 1);
            database.ref('cars/' + carId).set({
                ...car,
                id: carId,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        });
    }

    function logout() {
        Swal.fire({
            title: 'ออกจากระบบ?',
            text: "คุณต้องการออกจากระบบหรือไม่?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ใช่, ออกจากระบบ!',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                auth.signOut()
                    .then(() => {
                        currentUser = null;
                        showLoginModal();
                        mainContent.style.display = 'none';
                        document.body.classList.add('loading');
                        loadingIndicator.style.display = 'flex';
                        document.querySelectorAll('.container').forEach(c => c.classList.remove('loaded'));
                    })
                    .catch((error) => {
                        showSweetAlert('เกิดข้อผิดพลาดในการออกจากระบบ: ' + error.message, 'error');
                    });
            }
        });
    }



    function loadCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
            "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        currentMonthElement.textContent = `${monthNames[month]} ${year + 543}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const firstDayOfWeek = firstDay.getDay();
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

        calendarDays.innerHTML = '';

        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `
                <div class="day-number">${prevMonthLastDay - i}</div>
            `;
            calendarDays.appendChild(dayElement);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayElement = document.createElement('div');
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            dayElement.dataset.date = dateStr;

            const isPastDate = new Date(dateStr) < new Date(formatDate(new Date()));
            if (isCurrentMonth && i === today.getDate()) {
                dayElement.className = 'calendar-day today';
            } else if (isPastDate) {
                dayElement.className = 'calendar-day';
            } else {
                dayElement.className = 'calendar-day';
            }

            const dayBookings = bookings.filter(booking =>
                booking.startDate <= dateStr && booking.endDate >= dateStr
            );

            let bookingIndicator = '';
            if (dayBookings.length > 0) {
                dayElement.classList.add('has-booking');
                bookingIndicator = `<div class="booking-indicator">${dayBookings.length} การจอง</div>`;
            }

            dayElement.innerHTML = `
                <div class="day-number">${i}</div>
                ${bookingIndicator}
            `;

            dayElement.addEventListener('click', (e) => {
                if (currentUser) {
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('selected');
                    });
                    dayElement.classList.add('selected');
                    selectedDate = new Date(year, month, i);

                    const isPast = new Date(dateStr) < new Date(formatDate(new Date()));
                    if (isPast) {
                        showViewBookingsModal(selectedDate);
                    } else {
                        const rect = dayElement.getBoundingClientRect();
                        actionMenu.style.top = `${rect.bottom + window.scrollY}px`;
                        actionMenu.style.left = `${rect.left + window.scrollX}px`;

                        actionMenu.classList.add('active');
                    }
                } else {
                    showLoginModal();
                }

                e.stopPropagation();
            });

            calendarDays.appendChild(dayElement);
        }

        const totalCells = 42;
        const remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
        for (let i = 1; i <= remainingCells; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `
                <div class="day-number">${i}</div>
            `;
            calendarDays.appendChild(dayElement);
        }
    }

function updateMyTodayBookings() {
    const today = formatDate(new Date());
    const myTodayBookingsList = bookings.filter(booking =>
        booking.userId === currentUser.uid &&
        booking.startDate <= today && booking.endDate >= today
    ).sort((a, b) => new Date(b.startDate + 'T' + b.startTime) - new Date(a.startDate + 'T' + a.startTime));

    const pendingBookingsList = currentUser.role === 'admin' ? 
        bookings.filter(booking => booking.status === 'pending')
            .sort((a, b) => new Date(a.startDate + 'T' + a.startTime) - new Date(b.startDate + 'T' + b.startTime)) : [];

    myTodayBookings.innerHTML = '';

    // สำหรับแอดมิน: แสดงรายการที่รออนุมัติ
    if (currentUser.role === 'admin' && pendingBookingsList.length > 0) {
        const pendingSection = document.createElement('div');
        pendingSection.innerHTML = `
            <h4 style="margin: 16px 0 8px 0; color: var(--warning); display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-clock"></i>
                รายการจองที่รออนุมัติ
            </h4>
        `;
        myTodayBookings.appendChild(pendingSection);

        pendingBookingsList.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = 'my-booking-item pending';
            
            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const canEdit = !isPastDate && currentUser.role === 'admin'; // แอดมินแก้ไขได้

            bookingItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${getCarName(booking.carId)} - ${booking.bookerName}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))} | ${booking.startTime} - ${booking.endTime}</div>
                    </div>
                    <span class="status-badge status-pending">รออนุมัติ</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--dark); margin-bottom: 8px;">
                    <div>${getPurposeText(booking.purpose)} • ${booking.destination}</div>
                </div>
                <div class="booking-actions" style="display: flex; gap: 6px; justify-content: flex-end;">
                    ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">แก้ไข</button>` : ''}
                    <button class="btn btn-sm btn-approve" onclick="approveBooking('${booking.id}')">อนุมัติ</button>
                    <button class="btn btn-sm btn-reject" onclick="rejectBooking('${booking.id}')">ปฏิเสธ</button>
                </div>
            `;
            myTodayBookings.appendChild(bookingItem);
        });
    }

    // แสดงรายการจองของตัวเองวันนี้
    if (myTodayBookingsList.length === 0) {
        if (currentUser.role !== 'admin' || pendingBookingsList.length === 0) {
            myTodayBookings.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">ไม่มีรายการจองรถวันนี้</p>';
        }
    } else {
        const mySection = document.createElement('div');
        mySection.innerHTML = `
            <h4 style="margin: ${currentUser.role === 'admin' && pendingBookingsList.length > 0 ? '16px 0 8px 0' : '0 0 8px 0'}; color: var(--primary); display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-user"></i>
                การจองของฉันวันนี้
            </h4>
        `;
        myTodayBookings.appendChild(mySection);

        myTodayBookingsList.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `my-booking-item ${booking.status || 'pending'}`;
            
            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            
            // แก้ไขเงื่อนไข: แอดมินสามารถแก้ไขการจองที่รออนุมัติหรืออนุมัติแล้วได้
            const canEdit = !isPastDate && (
                (currentUser.role === 'admin' && (isPending || isApproved)) || // แอดมินแก้ไขได้ทั้งที่รออนุมัติและอนุมัติแล้ว
                (isPending) // ผู้ใช้แก้ไขได้เฉพาะที่รออนุมัติ
            );
            
            const canCancel = !isPastDate && (
                (currentUser.role === 'admin') || 
                (isPending || isApproved)
            );

            bookingItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${getCarName(booking.carId)}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))} | ${booking.startTime} - ${booking.endTime}</div>
                    </div>
                    <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--dark); margin-bottom: ${canEdit || canCancel ? '8px' : '0'};">
                    <div>${getPurposeText(booking.purpose)} • ${booking.destination}</div>
                </div>
                ${(canEdit || canCancel) ? `
                <div class="booking-actions" style="display: flex; gap: 6px; justify-content: flex-end;">
                    ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">แก้ไข</button>` : ''}
                    ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">ยกเลิก</button>` : ''}
                </div>
                ` : ''}
            `;
            myTodayBookings.appendChild(bookingItem);
        });
    }
}


    function updateCarSelect() {
        carSelect.innerHTML = '<option value="">-- เลือกรถ --</option>';
        cars.forEach(car => {
            const option = document.createElement('option');
            option.value = car.id;
            option.textContent = car.brand || car.name || 'ไม่ระบุ';
            carSelect.appendChild(option);
        });
    }

    function resetBookingForm() {
        bookingForm.reset();
        bookingIdInput.value = '';
        adminControls.style.display = 'none';
        document.getElementById('selfDrive').checked = true;
        document.getElementById('purposeNormal').checked = true;
        carSelectGroup.style.display = 'block';
        carSelect.setAttribute('required', 'required');

        const today = formatDate(new Date());
        startDateInput.value = today;
        endDateInput.value = today;
    }

    function resetCarForm() {
        carForm.reset();
        document.getElementById('carId').value = '';
    }

    function resetUserForm() {
        userForm.reset();
        document.getElementById('userUid').value = '';
        document.getElementById('userRole').value = 'user';
        document.getElementById('userPasswordGroup').style.display = 'block';
    }

    function showSweetAlert(message, type) {
        Swal.fire({
            title: type === 'success' ? 'สำเร็จ!' : 'เกิดข้อผิดพลาด!',
            text: message,
            icon: type,
            confirmButtonText: 'ตกลง',
            customClass: {
                popup: 'sweet-alert-popup'
            }
        });
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatThaiDate(date) {
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear() + 543;
        return `${day}/${month}/${year}`;
    }

    function getCarName(carId) {
        if (carId === 'none') return 'ไม่ต้องใช้รถ';
        const car = cars.find(c => c.id === carId);
        return car ? (car.brand || car.name || 'ไม่พบข้อมูลรถ') : 'ไม่พบข้อมูลรถ';
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': 'รออนุมัติ',
            'approved': 'อนุมัติ',
            'rejected': 'ปฏิเสธ'
        };
        return statusMap[status] || status;
    }

    function getPurposeText(purpose) {
        const purposeMap = {
            'normal': 'ปกติ',
            'leaveWork': 'ฝากงาน',
            'carToWork': 'ติดรถไปติดต่องาน'
        };
        return purposeMap[purpose] || purpose;
    }


function showEditBookingModal(bookingId) {
    const booking = bookings.find(b => b.id === bookingId);
    if (booking) {
        // ปิดหน้าต่างที่เปิดอยู่ทั้งหมด
        viewBookingsModal.classList.remove('active');
        myBookingsModal.classList.remove('active');
        
        // แสดงฟอร์มแก้ไขการจอง
        showBookingModal(null, booking);
    }
}
    document.addEventListener('DOMContentLoaded', initApp);



</script>
</body>
</html>


