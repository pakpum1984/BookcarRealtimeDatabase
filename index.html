<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --dark: #1C1C1E;
            --light: #F2F2F7;
            --gray: #8E8E93;
            --card-bg: #FFFFFF;
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --accent: #5856D6;
            --gradient-start: #007AFF;
            --gradient-end: #5856D6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Prompt", sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--light), #E6E6EB);
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        /* body.loading {
            opacity: 0;
        } */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .container.loaded {
            opacity: 1;
        }

        header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 2px 0;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 1.5rem;
            color: white;
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-approve {
            background: var(--secondary);
            color: white;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
        }

        /* Calendar Styles */
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 16px;
        }

        .calendar {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--light);
            font-weight: 500;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .calendar-weekdays div {
            padding: 10px;
            text-align: center;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--gray);
            font-size: 0.85rem;
        }

        .calendar-weekdays div:last-child {
            border-right: none;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            padding: 10px 6px;
            min-height: 80px;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background-color: rgba(0, 122, 255, 0.08);
            transform: scale(1.02);
        }

        .calendar-day.other-month {
            color: #C7C7CC;
            background-color: #FAFAFC;
        }

        .calendar-day.has-booking {
            background-color: rgba(52, 199, 89, 0.08);
        }

        .calendar-day.selected {
            background-color: rgba(0, 122, 255, 0.12);
            border: 2px solid var(--primary);
        }

        .calendar-day.today {
            background-color: rgba(255, 149, 0, 0.12);
            border: 2px solid var(--warning);
        }

        .calendar-day.disabled {
            background-color: #F0F0F0;
            color: #C7C7CC;
            cursor: not-allowed;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .booking-indicator {
            font-size: 0.65rem;
            color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            margin-top: 4px;
            display: inline-block;
            font-weight: 500;
        }

        /* Sidebar Styles */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .booking-summary {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-title i {
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(15px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--light);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Action Menu Styles */
        .action-menu {
            position: absolute;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            padding: 6px;
            z-index: 100;
            min-width: 140px;
            display: none;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(15px);
        }

        .action-menu.active {
            display: block;
            animation: modalAppear 0.2s ease;
        }

        .action-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .action-item:hover {
            background: var(--light);
        }

        .action-item.book {
            color: var(--primary);
        }

        .action-item.view {
            color: var(--secondary);
        }

        /* Login Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 32px;
            width: 100%;
            max-width: 380px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .login-title {
            text-align: center;
            margin-bottom: 24px;
            color: var(--dark);
            font-size: 1.4rem;
            font-weight: 600;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
            color: var(--primary);
            font-size: 2.5rem;
        }

        /* Loading Styles */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 122, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Styles */
        .alert {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .alert-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Status Badge */
        .status-badge {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .status-approved {
            background: rgba(52, 199, 89, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Booking List Styles */
        .booking-list {
            max-height: 360px;
            overflow-y: auto;
        }

        .booking-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--light);
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .booking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .booking-item.pending {
            border-left-color: var(--warning);
        }

        .booking-item.approved {
            border-left-color: var(--secondary);
        }

        .booking-item.rejected {
            border-left-color: var(--danger);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .booking-actions {
            display: flex;
            gap: 6px;
        }

        .booking-details {
            font-size: 0.8rem;
            color: var(--dark);
            line-height: 1.5;
        }

        /* My Bookings Styles */
        .my-bookings-list {
            max-height: 280px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .my-booking-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: var(--light);
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .my-booking-item:hover {
            transform: translateY(-1px);
        }

        .my-booking-item.pending {
            border-left-color: var(--warning);
        }

        .my-booking-item.approved {
            border-left-color: var(--secondary);
        }

        .my-booking-item.rejected {
            border-left-color: var(--danger);
        }

        /* Radio and Checkbox Styles */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #C7C7CC;
            border-radius: 50%;
            margin-right: 6px;
            position: relative;
            cursor: pointer;
        }

        input[type="radio"]:checked {
            border-color: var(--primary);
        }

        input[type="radio"]:checked::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Bottom Navigation for Mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.08);
            z-index: 100;
            padding: 8px 0;
        }

        .bottom-nav ul {
            display: flex;
            justify-content: space-around;
            list-style: none;
        }

        .bottom-nav li {
            text-align: center;
        }

        .bottom-nav a {
            color: var(--gray);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }

        .bottom-nav a.active {
            color: var(--primary);
        }

        .bottom-nav i {
            font-size: 1.3rem;
            margin-bottom: 3px;
        }

        /* Admin Management Styles */
        .admin-management {
            max-width: 800px;
            margin: 0 auto;
        }

        .tab-nav {
            display: flex;
            background: var(--light);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .tab-content.active {
            display: block;
        }

        .management-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--light);
        }

        .management-item-info {
            flex: 1;
        }

        .management-actions {
            display: flex;
            gap: 8px;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .calendar-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: row;
                gap: 10px;
                padding: 8px 16px;
            }

            .logo h1 {
                font-size: 1rem;
            }

            .user-info {
                gap: 8px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
            
            #userName {
            display: none;                 /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà avatar) */
            }
            .calendar-header {
                flex-direction: row;
                gap: 10px;
                padding: 12px;
            }

            .calendar-day {
                min-height: 70px;
                padding: 8px 3px;
            }

            .bottom-nav {
                display: block;
            }

            .container {
                padding-bottom: 60px;
            }

            .user-info button {
                display: none;
            }

            .management-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 576px) {

            
            .container {
                padding: 12px;
            }

            .card {
                padding: 12px;
            }

            .calendar-weekdays div {
                padding: 6px 2px;
                font-size: 0.75rem;
            }

            .calendar-day {
                min-height: 60px;
                padding: 6px 2px;
            }

            .day-number {
                font-size: 0.75rem;
            }

            .booking-indicator {
                font-size: 0.55rem;
            }
        }

                /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏î‡∏¥‡πâ‡∏á */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            font-size: 3rem;
            color: white;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á responsive styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        @media (max-width: 768px) {
            .admin-btn-desktop {
                display: none !important;
            }
        }

        @media (min-width: 769px) {
            .admin-btn-desktop {
                display: inline-block !important;
            }
        }


.mileage-section h4::before {
    content: "üìä";
    font-size: 1.2em;
}

.mileage-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-mileage {
    background: var(--warning);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.btn-mileage:hover {
    background: #e68900;
    transform: scale(1.05);
}

.mileage-info {
    font-size: 0.8rem;
    line-height: 1.4;
}







/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå */
.mileage-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-mileage {
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå */
.mileage-info {
    font-size: 0.8rem;
    line-height: 1.4;
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
.form-control[readonly] {
    background-color: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.form-control[readonly]:focus {
    box-shadow: none;
    border-color: #e9ecef;
}






/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå */
.mileage-section {
    background: rgba(255, 149, 0, 0.05);
    padding: 16px;
    border-radius: 10px;
    margin: 16px 0;
    border: 1px solid rgba(255, 149, 0, 0.2);
}

.mileage-section h4 {
    color: var(--warning);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
.form-group[style*="display: none"] {
    display: none !important;
}

input[style*="display: none"], 
select[style*="display: none"], 
textarea[style*="display: none"] {
    display: none !important;
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á */
.booking-info-section {
    background: rgba(0, 122, 255, 0.05);
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 16px;
    border: 1px solid rgba(0, 122, 255, 0.1);
}

.booking-info-section h4 {
    color: var(--primary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
    </style>
</head>
<body class="loading">
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏î‡∏¥‡πâ‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢ default) -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-car"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå...</div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="login-logo">
                    <i class="fas fa-car"></i>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="email" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="password" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </form>
                <div style="margin-top: 20px; padding: 16px; background: var(--light); border-radius: 12px;">
                    <h4 style="margin-bottom: 12px; color: var(--dark);">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h4>
               
                    <p style="margin-bottom: 8px; font-size: 0.9rem;"><strong>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:</strong> likit@bookcar.com / 123456</p>
                    <p style="font-size: 0.9rem;"><strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:</strong> adminbookcarcm2@email.com / adminbookcarcm2</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="bookingModalTitle">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookingId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="startDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="endDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="bookerName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                            <input type="text" id="bookerName" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="department">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                            <input type="text" id="department" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                        <div>
                            <input type="radio" id="purposeNormal" name="purpose" value="normal" checked>
                            <label for="purposeNormal">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ</label>
                            <input type="radio" id="purposeLeaveWork" name="purpose" value="leaveWork" style="margin-left: 15px;">
                            <label for="purposeLeaveWork">‡∏ù‡∏≤‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="radio" id="purposeCarToWork" name="purpose" value="carToWork" style="margin-left: 15px;">
                            <label for="purposeCarToWork">‡∏ï‡∏¥‡∏î‡∏£‡∏ñ‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                        </div>
                    </div>
                    <div class="form-group" id="carSelectGroup" style="display: none;">
                        <label class="form-label" for="carSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ</label>
                        <select id="carSelect" class="form-control">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡∏ö</label>
                        <div>
                            <input type="radio" id="selfDrive" name="driverStatus" value="self" required>
                            <label for="selfDrive">‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á</label>
                            <input type="radio" id="withDriver" name="driverStatus" value="with" style="margin-left: 15px;" required>
                            <label for="withDriver">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="startTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                            <input type="time" id="startTime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="endTime">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label>
                            <input type="time" id="endTime" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="destination">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="text" id="destination" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="notes">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                        <textarea id="notes" class="form-control" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div id="adminControls" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                            <div>
                                <input type="radio" id="statusPending" name="approvalStatus" value="pending">
                                <label for="statusPending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                <input type="radio" id="statusApproved" name="approvalStatus" value="approved" style="margin-left: 15px;">
                                <label for="statusApproved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                <input type="radio" id="statusRejected" name="approvalStatus" value="rejected" style="margin-left: 15px;">
                                <label for="statusRejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</label>
                            </div>
                        </div>
                    </div>

                    <!-- ‡πÉ‡∏ô bookingModal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
<div class="mileage-section" id="mileageSection" style="display: none;">
    <h4 style="margin: 16px 0 12px 0; color: var(--primary);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h4>
    
    <div class="form-row">
        <div class="form-group">
            <label class="form-label" for="actualStartTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á</label>
            <input type="time" id="actualStartTime" class="form-control">
        </div>
        <div class="form-group">
            <label class="form-label" for="mileageOut">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å</label>
            <input type="number" id="mileageOut" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å" min="0">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label class="form-label" for="actualEndTime">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á</label>
            <input type="time" id="actualEndTime" class="form-control">
        </div>
        <div class="form-group">
            <label class="form-label" for="mileageIn">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤</label>
            <input type="number" id="mileageIn" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤" min="0">
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label" for="mileageNotes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
        <textarea id="mileageNotes" class="form-control" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ"></textarea>
    </div>
</div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelBooking">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary" id="saveBooking" style="color: var(--light); background-color: var(--primary);" >‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Bookings Modal -->
    <div class="modal" id="viewBookingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="viewBookingsModalTitle">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="viewBookingsDate" style="margin-bottom: 20px; font-weight: bold;"></div>
                <div class="booking-list" id="bookingsList">
                    <!-- Bookings will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- My Bookings Modal -->
    <div class="modal" id="myBookingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="booking-list" id="myBookingsList">
                    <!-- My bookings will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Management Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="cars">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</button>
                    <button class="tab-btn" data-tab="users">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </div>
                <div class="tab-content active" id="carsTab">
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" id="addCarBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="management-list" id="carsList">
                        <!-- Cars will be listed here -->
                    </div>
                </div>
                <div class="tab-content" id="usersTab">
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" id="addUserBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="management-list" id="usersList">
                        <!-- Users will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Car Form Modal -->
    <div class="modal" id="carFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="carFormTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="carForm">
                    <input type="hidden" id="carId">
                    <div class="form-group">
                        <label class="form-label" for="carBrand">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
                        <input type="text" id="carBrand" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carColor">‡∏™‡∏µ</label>
                        <input type="text" id="carColor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carFuelType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label>
                        <select id="carFuelType" class="form-control" required>
                            <option value="gasoline">‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô</option>
                            <option value="diesel">‡∏î‡∏µ‡πÄ‡∏ã‡∏•</option>
                            <option value="electric">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carImageUrl">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                        <input type="url" id="carImageUrl" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="carLastMaintenance">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="carLastMaintenance" class="form-control">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelCarForm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Form Modal -->
    <div class="modal" id="userFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userFormTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userUid">
                    <div class="form-group">
                        <label class="form-label" for="userEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="userEmail" class="form-control" required>
                    </div>
                    <div class="form-group" id="userPasswordGroup">
                        <label class="form-label" for="userPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userDisplayName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="userDisplayName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userDepartment">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input type="text" id="userDepartment" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="userRole">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                        <select id="userRole" class="form-control" required>
                            <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelUserForm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Action Menu -->
    <div class="action-menu" id="actionMenu">
        <div class="action-item book" id="bookAction">
            <i class="fas fa-calendar-plus"></i>
            <span>‡∏à‡∏≠‡∏á‡∏£‡∏ñ</span>
        </div>
        <div class="action-item view" id="viewAction">
            <i class="fas fa-eye"></i>
            <span>‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-car"></i>
                        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</h1>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                        <button class="btn btn-secondary" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button class="btn btn-warning admin-btn-desktop" id="adminBtn" style="display: none;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div id="mainContent" style="display: none;">
                <div class="alert alert-success" id="successAlert" style="display: none;">
                    ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                </div>

                <div class="calendar-container">
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <h2 id="currentMonth">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2023</h2>
                            <button class="btn btn-primary" id="newBookingBtn" hidden>‡∏à‡∏≠‡∏á‡∏£‡∏ñ</button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</div>
                            <div>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</div>
                            <div>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</div>
                            <div>‡∏û‡∏∏‡∏ò</div>
                            <div>‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</div>
                            <div>‡∏®‡∏∏‡∏Å‡∏£‡πå</div>
                            <div>‡πÄ‡∏™‡∏≤‡∏£‡πå</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Calendar days will be generated by JavaScript -->
                        </div>
                    </div>

                    <div class="sidebar">
                        <div class="booking-summary card">
                            <h3 class="summary-title">
                                <i class="fas fa-list"></i>
                                ‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                            </h3>
                            <div id="myTodayBookings">
                                <!-- My today bookings will be listed here -->
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-primary btn-sm" id="viewAllMyBookingsBtn">
                                    <i class="fas fa-history"></i>
                                    ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                                </button>
                            </div>
                        </div>
                    </div><br>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav" id="bottomNav">
        <ul id="bottomNavUl">
            <li>
                <a href="#" id="homeNav" class="active">
                    <i class="fas fa-calendar"></i>
                    <span>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
                </a>
            </li>
            <li>
                <a href="#" id="bookingsNav">
                    <i class="fas fa-list"></i>
                    <span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                </a>
            </li>
            <li id="adminNavLi">
                <a href="#" id="adminNav">
                    <i class="fas fa-cog"></i>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
                </a>
            </li>
            <li>
                <a href="#" id="logoutNav">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                </a>
            </li>
        </ul>
    </nav>

    <script>



    const firebaseConfig = {
  apiKey: "AIzaSyDuek-870g_xTYbfXZTg824eU4c4WyvFf4",
  authDomain: "test-fe28a.firebaseapp.com",
  databaseURL: "https://test-fe28a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-fe28a",
  storageBucket: "test-fe28a.firebasestorage.app",
  messagingSenderId: "297402725045",
  appId: "1:297402725045:web:e9832657e3df5795c684fc",
  measurementId: "G-BJG2J0BF44"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
    let currentUser = null;
    let currentDate = new Date();
    let selectedDate = null;
    let selectedBooking = null;
    let cars = [];
    let users = [];
    let bookings = [];




    

    // DOM Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const loginModal = document.getElementById('loginModal');
    const bookingModal = document.getElementById('bookingModal');
    const viewBookingsModal = document.getElementById('viewBookingsModal');
    const myBookingsModal = document.getElementById('myBookingsModal');
    const adminModal = document.getElementById('adminModal');
    const carFormModal = document.getElementById('carFormModal');
    const userFormModal = document.getElementById('userFormModal');
    const loginForm = document.getElementById('loginForm');
    const bookingForm = document.getElementById('bookingForm');
    const carForm = document.getElementById('carForm');
    const userForm = document.getElementById('userForm');
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthElement = document.getElementById('currentMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const newBookingBtn = document.getElementById('newBookingBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminBtn = document.getElementById('adminBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const mainContent = document.getElementById('mainContent');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const successAlert = document.getElementById('successAlert');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const bookerNameInput = document.getElementById('bookerName');
    const departmentInput = document.getElementById('department');
    const carSelect = document.getElementById('carSelect');
    const carSelectGroup = document.getElementById('carSelectGroup');
    const bookingIdInput = document.getElementById('bookingId');
    const bookingModalTitle = document.getElementById('bookingModalTitle');
    const saveBookingBtn = document.getElementById('saveBooking');
    const adminControls = document.getElementById('adminControls');
    const actionMenu = document.getElementById('actionMenu');
    const bookAction = document.getElementById('bookAction');
    const viewAction = document.getElementById('viewAction');
    const bookingsList = document.getElementById('bookingsList');
    const viewBookingsDate = document.getElementById('viewBookingsDate');
    const myTodayBookings = document.getElementById('myTodayBookings');
    const viewAllMyBookingsBtn = document.getElementById('viewAllMyBookingsBtn');
    const myBookingsList = document.getElementById('myBookingsList');
    const carsList = document.getElementById('carsList');
    const usersList = document.getElementById('usersList');
    

    // Bottom Nav Elements
    const homeNav = document.getElementById('homeNav');
    const bookingsNav = document.getElementById('bookingsNav');
    const logoutNav = document.getElementById('logoutNav');
    const adminNavLi = document.getElementById('adminNavLi');
    const adminNav = document.getElementById('adminNav');
    const bottomNavUl = document.getElementById('bottomNavUl');

    function initApp() {
        // ‡πÅ‡∏™‡∏î‡∏á loading screen ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (remove hidden ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        loadingScreen.classList.remove('hidden');
        
        // ‡πÅ‡∏™‡∏î‡∏á loading ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô container
        document.body.classList.add('loading');
        loadingIndicator.style.display = 'flex';
        mainContent.style.display = 'none';
        document.querySelectorAll('.container').forEach(c => c.classList.remove('loaded'));

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                // Force fetch user data ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
                database.ref('users/' + currentUser.uid).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        console.log('Fetched user data:', userData); // Debug log (‡∏•‡∏ö‡πÑ‡∏î‡πâ)
                        if (userData) {
                            currentUser.displayName = userData.displayName || currentUser.email.split('@')[0];
                            currentUser.department = userData.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô set department
                            currentUser.role = userData.role || 'user';
                        } else {
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                            const username = currentUser.email.split('@')[0];
                            const displayName = username.charAt(0).toUpperCase() + username.slice(1) + ' User';
                            
                            database.ref('users/' + currentUser.uid).set({
                                displayName: displayName,
                                department: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                                role: 'user',
                                email: currentUser.email,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            });
                            
                            currentUser.displayName = displayName;
                            currentUser.department = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                            currentUser.role = 'user';
                        }
                        // Force reload global users ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin
                        if (currentUser.role === 'admin') {
                            loadUsers();
                        }
                        showMainApp();
                        loadCars();
                        loadBookings();
                    })
                    .catch((error) => {
                        console.error('Error fetching user data:', error);
                        showSweetAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                    });
            } else {
                showLoginModal();
                // ‡∏ã‡πà‡∏≠‡∏ô loading screen ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å auth ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    document.body.classList.remove('loading');
                    loadingIndicator.style.display = 'none';
                    document.querySelectorAll('.container').forEach(c => c.classList.add('loaded'));
                }, 500);
            }
        });

        // Set min date for booking inputs
        const today = formatDate(new Date());
        startDateInput.setAttribute('min', today);
        endDateInput.setAttribute('min', today);

        addEventListeners();
    }

function showMainApp() {
    // ‡∏ã‡πà‡∏≠‡∏ô loading screen
    loadingScreen.classList.add('hidden');
    
    loadingIndicator.style.display = 'none';
    mainContent.style.display = 'block';
    document.body.classList.remove('loading');
    document.querySelectorAll('.container').forEach(c => c.classList.add('loaded'));
    loadCalendar();

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
    updateUserDisplay();
}

function updateUserDisplay() {
    if (currentUser && currentUser.displayName) {
        // ‡πÉ‡∏ä‡πâ displayName ‡∏à‡∏≤‡∏Å currentUser ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        const displayName = currentUser.displayName;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
        userName.textContent = displayName;

        if (currentUser.role === 'admin') {
            adminControls.style.display = 'block';
            adminBtn.style.display = 'inline-block';
            // ‡πÅ‡∏™‡∏î‡∏á bottom nav ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
            adminNavLi.style.display = 'list-item';
            // ‡∏õ‡∏£‡∏±‡∏ö layout bottom nav ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ admin menu
            const liCount = bottomNavUl.children.length;
            bottomNavUl.style.justifyContent = liCount > 3 ? 'space-around' : 'space-around';
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            adminBtn.classList.add('admin-btn-desktop');
        } else {
            adminNavLi.style.display = 'none';
            adminBtn.style.display = 'none';
        }
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        const emailName = currentUser ? currentUser.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        userAvatar.textContent = emailName.charAt(0).toUpperCase();
        userName.textContent = emailName;
    }
}

    function addEventListeners() {
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', () => {
                loginModal.classList.remove('active');
                bookingModal.classList.remove('active');
                viewBookingsModal.classList.remove('active');
                myBookingsModal.classList.remove('active');
                adminModal.classList.remove('active');
                carFormModal.classList.remove('active');
                userFormModal.classList.remove('active');
            });
        });

        // Tab navigation for admin
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            });
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            loadCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            loadCalendar();
        });

        newBookingBtn.addEventListener('click', () => {
            showBookingModal();
        });

        adminBtn.addEventListener('click', () => {
            if (currentUser.role === 'admin') {
                adminModal.classList.add('active');
                loadCarsList();
                if (users.length === 0) {
                    database.ref('users').once('value').then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            users = Object.keys(data).map(key => ({
                                uid: key,
                                ...data[key]
                            }));
                        }
                        loadUsersList();
                    });
                } else {
                    loadUsersList();
                }
            } else {
                showSweetAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', 'error');
            }
        });

        logoutBtn.addEventListener('click', logout);
        loginForm.addEventListener('submit', handleLogin);
        bookingForm.addEventListener('submit', handleBooking);
        carForm.addEventListener('submit', handleCarForm);
        userForm.addEventListener('submit', handleUserForm);
        document.getElementById('cancelBooking').addEventListener('click', () => {
            bookingModal.classList.remove('active');
            resetBookingForm();
        });
        document.getElementById('cancelCarForm').addEventListener('click', () => {
            carFormModal.classList.remove('active');
            resetCarForm();
        });
        document.getElementById('cancelUserForm').addEventListener('click', () => {
            userFormModal.classList.remove('active');
            resetUserForm();
        });
        document.getElementById('addCarBtn').addEventListener('click', () => showCarFormModal());
        document.getElementById('addUserBtn').addEventListener('click', () => showUserFormModal());
        viewAllMyBookingsBtn.addEventListener('click', showMyBookingsModal);
        bookAction.addEventListener('click', () => {
            actionMenu.classList.remove('active');
            showBookingModal(selectedDate);
        });
        viewAction.addEventListener('click', () => {
            actionMenu.classList.remove('active');
            showViewBookingsModal(selectedDate);
        });
        document.querySelectorAll('input[name="purpose"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'normal') {
                    carSelectGroup.style.display = 'block';
                    carSelect.setAttribute('required', 'required');
                } else {
                    carSelectGroup.style.display = 'none';
                    carSelect.removeAttribute('required');
                    carSelect.value = '';
                }
            });
        });
        document.addEventListener('click', (e) => {
            if (!actionMenu.contains(e.target)) {
                actionMenu.classList.remove('active');
            }
        });
        homeNav.addEventListener('click', (e) => {
            e.preventDefault();
        });
        bookingsNav.addEventListener('click', (e) => {
            e.preventDefault();
            showMyBookingsModal();
        });
        logoutNav.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
        adminNav.addEventListener('click', (e) => {
            e.preventDefault();
            adminBtn.click();
        });
    }

    function showLoginModal() {
        loginModal.classList.add('active');
    }

function showBookingModal(selectedDay = null, bookingToEdit = null) {
    if (cars.length === 0) {
        showSweetAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'warning');
        return;
    }

    resetBookingForm();

    if (bookingToEdit) {
        // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
        bookingModalTitle.textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå";
        saveBookingBtn.textContent = "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        bookingIdInput.value = bookingToEdit.id;
        
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        startDateInput.value = bookingToEdit.startDate;
        endDateInput.value = bookingToEdit.endDate;
        bookerNameInput.value = bookingToEdit.bookerName;
        departmentInput.value = bookingToEdit.department;

        
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå
        document.querySelector(`input[name="purpose"][value="${bookingToEdit.purpose}"]`).checked = true;
        if (bookingToEdit.purpose === 'normal') {
            carSelectGroup.style.display = 'block';
            carSelect.value = bookingToEdit.carId;
        } else {
            carSelectGroup.style.display = 'none';
        }
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡∏ö
        document.querySelector(`input[name="driverStatus"][value="${bookingToEdit.driverStatus}"]`).checked = true;
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤
        document.getElementById('startTime').value = bookingToEdit.startTime;
        document.getElementById('endTime').value = bookingToEdit.endTime;
        document.getElementById('destination').value = bookingToEdit.destination;
        document.getElementById('notes').value = bookingToEdit.notes || '';
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (currentUser.role === 'admin') {
            adminControls.style.display = 'block';
            document.querySelector(`input[name="approvalStatus"][value="${bookingToEdit.status}"]`).checked = true;
        }
    } else {
        // ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà - Force fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
        if (currentUser) {
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        bookerNameInput.value = userData.displayName || currentUser.email.split('@')[0]; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô
                        departmentInput.value = userData.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // ‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        console.log('Fetched user for booking form - Name:', bookerNameInput.value, 'Dept:', departmentInput.value); // Debug log (‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
                    } else {
                        // Fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î)
                        bookerNameInput.value = currentUser.email.split('@')[0];
                        departmentInput.value = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    }
                })
                .catch((error) => {
                    console.error('Error fetching user data for booking:', error);
                    showSweetAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                });
        }

        if (selectedDay) {
            const dateStr = formatDate(selectedDay);
            startDateInput.value = dateStr;
            endDateInput.value = dateStr;
        } else {
            const today = formatDate(new Date());
            startDateInput.value = today;
            endDateInput.value = today;
        }

        bookingModalTitle.textContent = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå";
        saveBookingBtn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sync ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô modal ‡∏ô‡∏µ‡πâ)
    const handleDateChange = function() {
        if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
            endDateInput.value = startDateInput.value;
        }
        endDateInput.min = startDateInput.value;
    };

    const handleEndDateChange = function() {
        if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
            endDateInput.value = startDateInput.value;
        }
    };

    startDateInput.addEventListener('change', handleDateChange);
    endDateInput.addEventListener('change', handleEndDateChange);

    // ‡∏•‡∏ö listeners ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î modal
    const removeListeners = () => {
        startDateInput.removeEventListener('change', handleDateChange);
        endDateInput.removeEventListener('change', handleEndDateChange);
    };

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î modal
    bookingModal.addEventListener('click', function closeHandler(e) {
        if (!bookingModal.contains(e.target) || e.target.classList.contains('close-modal')) {
            removeListeners();
            bookingModal.removeEventListener('click', closeHandler);
        }
    });
    
    bookingModal.classList.add('active');
}


function showViewBookingsModal(selectedDay) {
    const dateStr = formatDate(selectedDay);
    const dayBookings = bookings.filter(booking =>
        booking.startDate <= dateStr && booking.endDate >= dateStr
    ).sort((a, b) => new Date(b.startDate + 'T' + b.startTime) - new Date(a.startDate + 'T' + a.startTime));

    viewBookingsDate.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(selectedDay)} (‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`;
    bookingsList.innerHTML = '';

    if (dayBookings.length === 0) {
        bookingsList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
    } else {
        dayBookings.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `booking-item ${booking.status || 'pending'}`;

            const isAdmin = currentUser.role === 'admin';
            const isOwner = booking.userId === currentUser.uid;
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            const isPastDate = new Date(booking.startDate) <= new Date(formatDate(new Date()));
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ
            const canEdit = !isPastDate && (
                (isAdmin && (isPending || isApproved)) || // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                (isOwner && isPending) // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            );
            
            const canCancel = !isPastDate && (
                (isAdmin) || 
                (isOwner && (isPending || isApproved))
            );

            bookingItem.innerHTML = `
                <div class="booking-header">
                    <div>
                        <strong>${booking.bookerName}</strong> - ${getCarName(booking.carId)} (${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))})
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div class="booking-actions">
                        ${isAdmin && isPending ? `<button class="btn btn-sm btn-approve" onclick="approveBooking('${booking.id}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>` : ''}
                        ${isAdmin && isPending ? `<button class="btn btn-sm btn-reject" onclick="rejectBooking('${booking.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>` : ''}
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                        ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                    </div>
                </div>
                <div class="booking-details">
                    <div>‡πÄ‡∏ß‡∏•‡∏≤: ${booking.startTime} - ${booking.endTime}</div>
                    <div>‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${booking.destination}</div>
                    <div style="font-size: 0.8rem; color: var(--dark);">
                        ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${getPurposeText(booking.purpose)} 
                        ‚Ä¢ 
                        ${booking.driverStatus === 'self' ? '‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö'}
                    </div>
                    ${booking.notes ? `<div>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${booking.notes}</div>` : ''}
                </div>
            `;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå
            addMileageActionButtons(bookingItem, booking);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            if (booking.status === 'approved' && booking.approvedBy) {
                const approverInfo = document.createElement('div');
                approverInfo.style.fontSize = '0.8rem';
                approverInfo.style.color = 'var(--secondary)';
                approverInfo.style.marginTop = '5px';
                approverInfo.innerHTML = `<i class="fas fa-user-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${booking.approvedBy}`;
                bookingItem.appendChild(approverInfo);
            }

            bookingsList.appendChild(bookingItem);
        });
    }

    viewBookingsModal.classList.add('active');
}



    function editBooking(bookingId) {
        const booking = bookings.find(b => b.id === bookingId);
        if (booking) {
            showBookingModal(null, booking);
        }
    }

    function approveBooking(bookingId) {
    const approverName = currentUser.displayName || currentUser.email;
    database.ref('bookings/' + bookingId).update({ 
        status: 'approved',
        approvedBy: approverName,
        approvedAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        showSweetAlert('‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', 'success');
        viewBookingsModal.classList.remove('active');
        updateMyTodayBookings();
    })
    .catch((error) => {
        showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    });
}

    function rejectBooking(bookingId) {
        updateBookingStatus(bookingId, 'rejected');
    }

    function updateBookingStatus(bookingId, status) {
        database.ref('bookings/' + bookingId).update({ status: status })
            .then(() => {
                showSweetAlert(`‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ñ‡∏π‡∏Å${status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                viewBookingsModal.classList.remove('active');
                updateMyTodayBookings(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            })
            .catch((error) => {
                showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            });
    }

function showMyBookingsModal() {
    const myBookings = bookings.filter(booking => booking.userId === currentUser.uid)
        .sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

    myBookingsList.innerHTML = '';

    if (myBookings.length === 0) {
        myBookingsList.innerHTML = '<p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ</p>';
    } else {
        myBookings.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `booking-item ${booking.status || 'pending'}`;

            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ
            const canEdit = !isPastDate && (
                (currentUser.role === 'admin' && (isPending || isApproved)) || // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                (isPending) // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            );
            
            const canCancel = !isPastDate && (
                (currentUser.role === 'admin') || 
                (isPending || isApproved)
            );

            bookingItem.innerHTML = `
                <div class="booking-header">
                    <div>
                        <strong>${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))}</strong> - ${getCarName(booking.carId)}
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div class="booking-actions">
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                        ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                    </div>
                </div>
                <div class="booking-details">
                    <div>‡πÄ‡∏ß‡∏•‡∏≤: ${booking.startTime} - ${booking.endTime}</div>
                    <div>‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${booking.destination}</div>
                    <div>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${getPurposeText(booking.purpose)}</div>
                    ${booking.notes ? `<div>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${booking.notes}</div>` : ''}
                </div>
            `;
            myBookingsList.appendChild(bookingItem);
        });
    }

    myBookingsModal.classList.add('active');
}




    function editCar(carId) {
        const car = cars.find(c => c.id === carId);
        if (car) {
            showCarFormModal(car);
        } else {
            showSweetAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ', 'error');
        }
    }

    function editUser(uid) {
        const user = users.find(u => u.uid === uid);
        if (user) {
            showUserFormModal(user);
        } else {
            showSweetAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
        }
    }

    function showCarFormModal(car = null) {
        resetCarForm();
        if (car) {
            document.getElementById('carFormTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏ñ';
            document.getElementById('carId').value = car.id;
            document.getElementById('carBrand').value = car.brand || '';
            document.getElementById('carColor').value = car.color || '';
            document.getElementById('carFuelType').value = car.fuelType || 'gasoline';
            document.getElementById('carImageUrl').value = car.imageUrl || '';
            document.getElementById('carLastMaintenance').value = car.lastMaintenance ? new Date(car.lastMaintenance).toISOString().split('T')[0] : '';
        } else {
            document.getElementById('carFormTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('carId').value = '';
        }
        carFormModal.classList.add('active');
    }

    function showUserFormModal(user = null) {
        resetUserForm();
        document.getElementById('userPasswordGroup').style.display = user ? 'none' : 'block';
        if (user) {
            document.getElementById('userFormTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            document.getElementById('userUid').value = user.uid;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userDisplayName').value = user.displayName || '';
            document.getElementById('userDepartment').value = user.department || '';
            document.getElementById('userRole').value = user.role || 'user';
        } else {
            document.getElementById('userFormTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('userUid').value = '';
        }
        userFormModal.classList.add('active');
    }


    function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á)
    const swalLoading = Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            return database.ref('users/' + currentUser.uid).once('value');
        })
        .then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                currentUser.displayName = userData.displayName || currentUser.email.split('@')[0];
                currentUser.role = userData.role || 'user';
                currentUser.department = userData.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            } else {
                const username = currentUser.email.split('@')[0];
                const displayName = username.charAt(0).toUpperCase() + username.slice(1) + ' User';
                return database.ref('users/' + currentUser.uid).set({
                    displayName: displayName,
                    department: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    role: 'user',
                    email: currentUser.email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    currentUser.displayName = displayName;
                    currentUser.role = 'user';
                    currentUser.department = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                });
            }
        })
        .then(() => {
            swalLoading.close(); // ‡∏õ‡∏¥‡∏î loading
            loginModal.classList.remove('active');
            showMainApp();
            showSweetAlert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        })
        .catch((error) => {
            swalLoading.close(); // ‡∏õ‡∏¥‡∏î loading ‡πÅ‡∏°‡πâ‡πÄ‡∏Å‡∏¥‡∏î error
            let errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (error.code === 'auth/user-not-found') errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            else if (error.code === 'auth/wrong-password') errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            else if (error.code === 'auth/invalid-email') errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            else if (error.code === 'auth/too-many-requests') errorMessage = '‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';

            showSweetAlert(errorMessage, 'error');
        });
}







function handleBooking(e) {
    e.preventDefault();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≠‡∏á‡∏£‡∏ñ
    const isRecordingMileage = document.getElementById('mileageSection').style.display !== 'none';
    
    if (isRecordingMileage) {
        handleMileageRecording();
        return;
    }

    // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ (‡∏°‡∏µ required ‡∏≠‡∏¢‡∏π‡πà)
    const purposeInput = document.querySelector('input[name="purpose"]:checked');
    if (!purposeInput) {
        showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå', 'error');
        return;
    }
    const purpose = purposeInput.value;

    let carId = 'none';
    if (purpose === 'normal') {
        if (!carSelect || !carSelect.value) {
            showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', 'error');
            return;
        }
        carId = carSelect.value;
    }

    if (!startDateInput || !startDateInput.value) {
        showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å', 'error');
        return;
    }

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    const today = formatDate(new Date());
    if (new Date(startDate) < new Date(today)) {
        showSweetAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ', 'error');
        return;
    }

    if (new Date(endDate) < new Date(startDate)) {
        showSweetAlert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å', 'error');
        return;
    }

    if (!document.getElementById('startTime') || !document.getElementById('startTime').value) {
        showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
        return;
    }

    if (!document.getElementById('endTime') || !document.getElementById('endTime').value) {
        showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
        return;
    }

    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const bookingId = bookingIdInput.value || '';

    if (purpose === 'normal') {
        // ‡πÄ‡∏ä‡πá‡∏Ñ conflict ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á startDate ‡πÅ‡∏•‡∏∞ endDate
        const start = new Date(startDate);
        const end = new Date(endDate);
        let hasConflict = false;
        let currentDate = new Date(start);
        while (currentDate <= end) {
            const currentDateStr = formatDate(currentDate);
            const dayBookings = bookings.filter(booking =>
                booking.id !== bookingId &&
                booking.carId === carId &&
                booking.status !== 'rejected' &&
                (booking.startDate <= currentDateStr && booking.endDate >= currentDateStr) &&
                ((startTime >= booking.startTime && startTime < booking.endTime) ||
                 (endTime > booking.startTime && endTime <= booking.endTime) ||
                 (startTime <= booking.startTime && endTime >= booking.endTime))
            );
            if (dayBookings.length > 0) {
                hasConflict = true;
                break;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (hasConflict) {
            showSweetAlert('‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'error');
            return;
        }
    }

    const bookingData = {
        startDate: startDate,
        endDate: endDate,
        bookerName: bookerNameInput.value,
        department: departmentInput.value,
        carId: carId,
        purpose: purpose,
        driverStatus: document.querySelector('input[name="driverStatus"]:checked')?.value || 'self',
        startTime: startTime,
        endTime: endTime,
        destination: document.getElementById('destination').value,
        notes: document.getElementById('notes').value,
        userId: currentUser.uid,
        status: currentUser.role === 'admin' ? (document.querySelector('input[name="approvalStatus"]:checked')?.value || 'approved') : 'pending'
    };

    if (bookingId) {
        updateBooking(bookingId, bookingData);
    } else {
        createBooking(bookingData);
    }
}

    function createBooking(bookingData) {
        const newBookingRef = database.ref('bookings').push();
        bookingData.id = newBookingRef.key;
        bookingData.createdAt = firebase.database.ServerValue.TIMESTAMP;

        newBookingRef.set(bookingData)
            .then(() => {
                bookingModal.classList.remove('active');
                showSweetAlert('‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'success');
                resetBookingForm();
            })
            .catch((error) => {
                showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ' + error.message, 'error');
            });
    }

    function updateBooking(bookingId, bookingData) {
        database.ref('bookings/' + bookingId).update(bookingData)
            .then(() => {
                bookingModal.classList.remove('active');
                showSweetAlert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                resetBookingForm();
                updateMyTodayBookings(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            })
            .catch((error) => {
                showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï: ' + error.message, 'error');
            });
    }

    function cancelBooking(bookingId) {
        const booking = bookings.find(b => b.id === bookingId);

        if (!booking) return;

        const isAdmin = currentUser.role === 'admin';
        const isOwner = booking.userId === currentUser.uid;
        const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));

        if (!isAdmin && !isOwner) {
            showSweetAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'error');
            return;
        }

        if (!isAdmin && isPastDate) {
            showSweetAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ', 'error');
            return;
        }

        Swal.fire({
            title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å!',
            cancelButtonText: '‡πÑ‡∏°‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('bookings/' + bookingId).remove()
                    .then(() => {
                        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        viewBookingsModal.classList.remove('active');
                        myBookingsModal.classList.remove('active');
                        showSweetAlert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        updateMyTodayBookings(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    })
                    .catch((error) => {
                        showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ' + error.message, 'error');
                    });
            }
        });
    }

    function handleCarForm(e) {
        e.preventDefault();
        const carId = document.getElementById('carId').value;
        const carData = {
            brand: document.getElementById('carBrand').value,
            color: document.getElementById('carColor').value,
            fuelType: document.getElementById('carFuelType').value,
            imageUrl: document.getElementById('carImageUrl').value,
            lastMaintenance: document.getElementById('carLastMaintenance').value ? new Date(document.getElementById('carLastMaintenance').value).toISOString() : null,
            createdAt: carId ? cars.find(c => c.id === carId).createdAt : firebase.database.ServerValue.TIMESTAMP
        };

        if (carId) {
            database.ref('cars/' + carId).update(carData)
                .then(() => {
                    showSweetAlert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    carFormModal.classList.remove('active');
                    loadCars();
                    loadCarsList();
                })
                .catch((error) => {
                    showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                });
        } else {
            const newCarRef = database.ref('cars').push();
            carData.id = newCarRef.key;
            newCarRef.set(carData)
                .then(() => {
                    showSweetAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    carFormModal.classList.remove('active');
                    loadCars();
                    loadCarsList();
                })
                .catch((error) => {
                    showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                });
        }
    }

    function handleUserForm(e) {
        e.preventDefault();
        const uid = document.getElementById('userUid').value;
        const isNewUser = !uid;
        const email = document.getElementById('userEmail').value;
        const password = document.getElementById('userPassword').value;
        const userData = {
            displayName: document.getElementById('userDisplayName').value,
            department: document.getElementById('userDepartment').value,
            role: document.getElementById('userRole').value,
            createdAt: isNewUser ? firebase.database.ServerValue.TIMESTAMP : users.find(u => u.uid === uid).createdAt,
            email: email
        };

        if (isNewUser) {
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const newUid = userCredential.user.uid;
                    userData.uid = newUid;
                    return database.ref('users/' + newUid).set(userData);
                })
                .then(() => {
                    showSweetAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    userFormModal.classList.remove('active');
                    loadUsers();
                    loadUsersList();
                })
                .catch((error) => {
                    showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                });
        } else {
            database.ref('users/' + uid).update(userData)
                .then(() => {
                    showSweetAlert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    userFormModal.classList.remove('active');
                    loadUsers();
                    loadUsersList();
                })
                .catch((error) => {
                    showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                });
        }
    }

    function deleteCar(carId) {
        Swal.fire({
            title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('cars/' + carId).remove()
                    .then(() => {
                        showSweetAlert('‡∏•‡∏ö‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        loadCars();
                        loadCarsList();
                    })
                    .catch((error) => {
                        showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    });
                }
        });
    }

    function deleteUser(uid) {
        Swal.fire({
            title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Firebase Auth ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏ú‡πà‡∏≤‡∏ô Admin SDK)",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                database.ref('users/' + uid).remove()
                    .then(() => {
                        showSweetAlert('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        loadUsers();
                        loadUsersList();
                    })
                    .catch((error) => {
                        showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    });
            }
        });
    }

    function loadCars() {
        database.ref('cars').on('value', (snapshot) => {
            const carsData = snapshot.val();
            if (carsData) {
                cars = Object.keys(carsData).map(key => ({
                    id: key,
                    ...carsData[key]
                }));
                updateCarSelect();
            } else {
                initializeCars();
            }
        });
    }

    function loadUsers() {
        database.ref('users').on('value', (snapshot) => {
            const usersData = snapshot.val();
            if (usersData) {
                users = Object.keys(usersData).map(key => ({
                    uid: key,
                    ...usersData[key]
                }));
            } else {
                users = [];
            }
            if (adminModal.classList.contains('active')) {
                loadUsersList();
            }
        });
    }

    function loadBookings() {
        database.ref('bookings').on('value', (snapshot) => {
            const bookingsData = snapshot.val();
            if (bookingsData) {
                bookings = Object.keys(bookingsData).map(key => ({
                    id: key,
                    ...bookingsData[key]
                }));
                loadCalendar();
                updateMyTodayBookings();
            }
        });
    }

    function loadCarsList() {
        carsList.innerHTML = '';
        cars.forEach(car => {
            const carItem = document.createElement('div');
            carItem.className = 'management-item';
            carItem.innerHTML = `
                <div class="management-item-info">
                    <strong>${car.brand || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} (${car.color || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'})</strong>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        ID: ${car.id} | ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ${car.fuelType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${car.lastMaintenance ? new Date(car.lastMaintenance).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                    </div>
                </div>
                <div class="management-actions">
                    <button class="btn btn-sm btn-primary" onclick="editCar('${car.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCar('${car.id}')">‡∏•‡∏ö</button>
                </div>
            `;
            carsList.appendChild(carItem);
        });
        if (cars.length === 0) {
            carsList.innerHTML = '<p style="text-align: center; color: var(--gray);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</p>';
        }
    }

    function loadUsersList() {
        usersList.innerHTML = '';
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (users.length === 0) {
            usersList.innerHTML = '<p style="text-align: center; color: var(--gray);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
            return;
        }
        
        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'management-item';
            userItem.innerHTML = `
                <div class="management-item-info">
                    <strong>${user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} (${user.role === 'admin' ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô' : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'})</strong>
                    <div style="font-size: 0.85rem; color: var(--gray);">
                        ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${user.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | ‡πÅ‡∏ú‡∏ô‡∏Å: ${user.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                    </div>
                </div>
                <div class="management-actions">
                    <button class="btn btn-sm btn-primary" onclick="editUser('${user.uid}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.uid}')">‡∏•‡∏ö</button>
                </div>
            `;
            usersList.appendChild(userItem);
        });
    }

    function initializeCars() {
        const defaultCars = [
            { brand: 'Toyota', color: '‡∏Ç‡∏≤‡∏ß', fuelType: 'gasoline', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Honda', color: '‡∏î‡∏≥', fuelType: 'gasoline', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Mazda', color: '‡πÅ‡∏î‡∏á', fuelType: 'diesel', imageUrl: '', lastMaintenance: '2023-09-15' },
            { brand: 'Ford', color: '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', fuelType: 'diesel', imageUrl: '', lastMaintenance: '2023-09-15' }
        ];

        defaultCars.forEach((car, index) => {
            const carId = 'car' + (index + 1);
            database.ref('cars/' + carId).set({
                ...car,
                id: carId,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        });
    }

    function logout() {
        Swal.fire({
            title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
            text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                auth.signOut()
                    .then(() => {
                        currentUser = null;
                        showLoginModal();
                        mainContent.style.display = 'none';
                        document.body.classList.add('loading');
                        loadingIndicator.style.display = 'flex';
                        document.querySelectorAll('.container').forEach(c => c.classList.remove('loaded'));
                    })
                    .catch((error) => {
                        showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message, 'error');
                    });
            }
        });
    }



    function loadCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
            "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        currentMonthElement.textContent = `${monthNames[month]} ${year + 543}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const firstDayOfWeek = firstDay.getDay();
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

        calendarDays.innerHTML = '';

        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `
                <div class="day-number">${prevMonthLastDay - i}</div>
            `;
            calendarDays.appendChild(dayElement);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayElement = document.createElement('div');
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            dayElement.dataset.date = dateStr;

            const isPastDate = new Date(dateStr) < new Date(formatDate(new Date()));
            if (isCurrentMonth && i === today.getDate()) {
                dayElement.className = 'calendar-day today';
            } else if (isPastDate) {
                dayElement.className = 'calendar-day';
            } else {
                dayElement.className = 'calendar-day';
            }

            const dayBookings = bookings.filter(booking =>
                booking.startDate <= dateStr && booking.endDate >= dateStr
            );

            let bookingIndicator = '';
            if (dayBookings.length > 0) {
                dayElement.classList.add('has-booking');
                bookingIndicator = `<div class="booking-indicator">${dayBookings.length} ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>`;
            }

            dayElement.innerHTML = `
                <div class="day-number">${i}</div>
                ${bookingIndicator}
            `;

            dayElement.addEventListener('click', (e) => {
                if (currentUser) {
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('selected');
                    });
                    dayElement.classList.add('selected');
                    selectedDate = new Date(year, month, i);

                    const isPast = new Date(dateStr) < new Date(formatDate(new Date()));
                    if (isPast) {
                        showViewBookingsModal(selectedDate);
                    } else {
                        const rect = dayElement.getBoundingClientRect();
                        actionMenu.style.top = `${rect.bottom + window.scrollY}px`;
                        actionMenu.style.left = `${rect.left + window.scrollX}px`;

                        actionMenu.classList.add('active');
                    }
                } else {
                    showLoginModal();
                }

                e.stopPropagation();
            });

            calendarDays.appendChild(dayElement);
        }

        const totalCells = 42;
        const remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
        for (let i = 1; i <= remainingCells; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `
                <div class="day-number">${i}</div>
            `;
            calendarDays.appendChild(dayElement);
        }
    }

function updateMyTodayBookings() {
    const today = formatDate(new Date());
    
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    const myTodayBookingsList = currentUser.role === 'admin' 
        ? bookings.filter(booking => 
            booking.startDate <= today && booking.endDate >= today
          ).sort((a, b) => new Date(b.startDate + 'T' + b.startTime) - new Date(a.startDate + 'T' + a.startTime))
        : bookings.filter(booking =>
            booking.userId === currentUser.uid &&
            booking.startDate <= today && booking.endDate >= today
          ).sort((a, b) => new Date(b.startDate + 'T' + b.startTime) - new Date(a.startDate + 'T' + a.startTime));

    const pendingBookingsList = currentUser.role === 'admin' ? 
        bookings.filter(booking => booking.status === 'pending')
            .sort((a, b) => new Date(a.startDate + 'T' + a.startTime) - new Date(b.startDate + 'T' + b.startTime)) : [];

    myTodayBookings.innerHTML = '';

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    if (currentUser.role === 'admin' && pendingBookingsList.length > 0) {
        const pendingSection = document.createElement('div');
        pendingSection.innerHTML = `
            <h4 style="margin: 16px 0 8px 0; color: var(--warning); display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-clock"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </h4>
        `;
        myTodayBookings.appendChild(pendingSection);

        pendingBookingsList.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = 'my-booking-item pending';
            
            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const canEdit = !isPastDate && currentUser.role === 'admin';

            bookingItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${getCarName(booking.carId)} - ${booking.bookerName}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))} | ${booking.startTime} - ${booking.endTime}</div>
                    </div>
                    <span class="status-badge status-pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--dark); margin-bottom: 8px;">
                    <div>${getPurposeText(booking.purpose)} ‚Ä¢ ${booking.destination}</div>
                </div>
                <div class="booking-actions" style="display: flex; gap: 6px; justify-content: flex-end;">
                    ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                    <button class="btn btn-sm btn-approve" onclick="approveBooking('${booking.id}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button class="btn btn-sm btn-reject" onclick="rejectBooking('${booking.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                </div>
            `;
            myTodayBookings.appendChild(bookingItem);
        });
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    if (myTodayBookingsList.length === 0) {
        if (currentUser.role !== 'admin' || pendingBookingsList.length === 0) {
            myTodayBookings.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
        }
    } else {
        const sectionTitle = currentUser.role === 'admin' ? '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
        const sectionIcon = currentUser.role === 'admin' ? 'fas fa-list' : 'fas fa-user';
        
        const mySection = document.createElement('div');
        mySection.innerHTML = `
            <h4 style="margin: ${currentUser.role === 'admin' && pendingBookingsList.length > 0 ? '16px 0 8px 0' : '0 0 8px 0'}; color: var(--primary); display: flex; align-items: center; gap: 6px;">
                <i class="${sectionIcon}"></i>
                ${sectionTitle}
            </h4>
        `;
        myTodayBookings.appendChild(mySection);

        myTodayBookingsList.forEach(booking => {
            const bookingItem = document.createElement('div');
            bookingItem.className = `my-booking-item ${booking.status || 'pending'}`;
            
            const isPastDate = new Date(booking.startDate) < new Date(formatDate(new Date()));
            const isPending = booking.status === 'pending';
            const isApproved = booking.status === 'approved';
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
            const isPastOrToday = new Date(booking.startDate) <= new Date(formatDate(new Date()));
            const canRecordMileage = isPastOrToday && (currentUser.role === 'admin' || booking.userId === currentUser.uid);
            
            const hasMileageOut = booking.mileageOut && booking.mileageOut !== '';
            const hasMileageIn = booking.mileageIn && booking.mileageIn !== '';
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            const canEdit = !isPastDate && (
                (currentUser.role === 'admin' && (isPending || isApproved)) || 
                (booking.userId === currentUser.uid && isPending)
            );
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            const canCancel = !isPastDate && !hasMileageOut && (
                (currentUser.role === 'admin') || 
                (booking.userId === currentUser.uid && (isPending || isApproved))
            );

            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢
            const displayCarInfo = currentUser.role === 'admin' 
                ? `${getCarName(booking.carId)} - ${booking.bookerName}`
                : getCarName(booking.carId);

            // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            if (hasMileageIn) {
                bookingItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${displayCarInfo}</div>
                            <div style="font-size: 0.8rem; color: var(--gray);">
                                ${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))} | ${booking.startTime} - ${booking.endTime}
                                ${currentUser.role === 'admin' && booking.userId !== currentUser.uid ? '<br><span style="color: var(--accent);">üë§ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</span>' : ''}
                            </div>
                        </div>
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--dark); margin-bottom: 8px;">
                        <div>${getPurposeText(booking.purpose)} ‚Ä¢ ${booking.destination}</div>
                    </div>
                `;
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤
                bookingItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${displayCarInfo}</div>
                            <div style="font-size: 0.8rem; color: var(--gray);">
                                ${formatThaiDate(new Date(booking.startDate))} - ${formatThaiDate(new Date(booking.endDate))} | ${booking.startTime} - ${booking.endTime}
                                ${currentUser.role === 'admin' && booking.userId !== currentUser.uid ? '<br><span style="color: var(--accent);">üë§ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</span>' : ''}
                            </div>
                        </div>
                        <span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status || 'pending')}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--dark); margin-bottom: ${canEdit || canCancel || canRecordMileage ? '8px' : '0'};">
                        <div>${getPurposeText(booking.purpose)} ‚Ä¢ ${booking.destination}</div>
                    </div>
                    ${(canEdit || canCancel || canRecordMileage) ? `
                    <div class="booking-actions" style="display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap;">
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="showEditBookingModal('${booking.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                        ${canCancel ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                        ${canRecordMileage ? `
                            <button class="btn btn-sm ${!hasMileageOut ? 'btn-warning' : !hasMileageIn ? 'btn-secondary' : 'btn-primary'}" onclick="showMileageForm('${booking.id}')">
                                <i class="fas fa-tachometer-alt"></i> 
                                ${!hasMileageOut ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å' : !hasMileageIn ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡∏•‡πå'}
                            </button>
                        ` : ''}
                    </div>
                    ` : ''}
                `;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (hasMileageOut || hasMileageIn) {
                const mileageInfo = document.createElement('div');
                mileageInfo.className = 'mileage-info';
                mileageInfo.style.marginTop = '8px';
                mileageInfo.style.padding = '8px';
                mileageInfo.style.background = 'rgba(52, 199, 89, 0.1)';
                mileageInfo.style.borderRadius = '6px';
                mileageInfo.style.fontSize = '0.75rem';

                let infoHTML = '<strong><i class="fas fa-tachometer-alt"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå:</strong><br>';

                if (hasMileageOut) {
                    infoHTML += `‡∏≠‡∏≠‡∏Å: ${booking.mileageOut} ‡∏Å‡∏°.`;
                    if (booking.actualStartTime) infoHTML += ` (‡∏≠‡∏≠‡∏Å ${booking.actualStartTime})`;
                    if (booking.mileageOutRecordedBy) infoHTML += ` ‡πÇ‡∏î‡∏¢ ${booking.mileageOutRecordedBy}`;
                    infoHTML += '<br>';
                }

                if (hasMileageIn) {
                    infoHTML += `‡πÄ‡∏Ç‡πâ‡∏≤: ${booking.mileageIn} ‡∏Å‡∏°.`;
                    if (booking.actualEndTime) infoHTML += ` (‡πÄ‡∏Ç‡πâ‡∏≤ ${booking.actualEndTime})`;
                    if (booking.mileageInRecordedBy) infoHTML += ` ‡πÇ‡∏î‡∏¢ ${booking.mileageInRecordedBy}`;
                    const distance = parseInt(booking.mileageIn) - parseInt(booking.mileageOut);
                    infoHTML += `<br><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°.</strong>`;
                } else if (hasMileageOut) {
                    infoHTML += '‚è≥ ‡∏£‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤';
                }

                if (booking.mileageNotes) {
                    infoHTML += `<br>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${booking.mileageNotes}`;
                }

                mileageInfo.innerHTML = infoHTML;
                bookingItem.appendChild(mileageInfo);
            }
            
            myTodayBookings.appendChild(bookingItem);
        });
    }
}


    function updateCarSelect() {
        carSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>';
        cars.forEach(car => {
            const option = document.createElement('option');
            option.value = car.id;
            option.textContent = car.brand || car.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            carSelect.appendChild(option);
        });
    }

function resetBookingForm() {
    bookingForm.reset();
    bookingIdInput.value = '';
    adminControls.style.display = 'none';
    carSelectGroup.style.display = 'block';
    
    // ‡∏ï‡∏±‡πâ‡∏á required ‡πÉ‡∏´‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    document.getElementById('startDate').setAttribute('required', 'required');
    document.getElementById('endDate').setAttribute('required', 'required');
    document.getElementById('startTime').setAttribute('required', 'required');
    document.getElementById('endTime').setAttribute('required', 'required');
    document.getElementById('destination').setAttribute('required', 'required');
    document.querySelectorAll('input[name="driverStatus"]').forEach(radio => {
        radio.setAttribute('required', 'required');
    });
    
    // ‡∏ï‡∏±‡πâ‡∏á required ‡πÉ‡∏´‡πâ carSelect ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    const purposeNormal = document.getElementById('purposeNormal');
    if (purposeNormal && purposeNormal.checked) {
        document.getElementById('carSelect').setAttribute('required', 'required');
    }

    const today = formatDate(new Date());
    startDateInput.value = today;
    endDateInput.value = today;
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢
    resetMileageForm();
}
    function resetCarForm() {
        carForm.reset();
        document.getElementById('carId').value = '';
    }

    function resetUserForm() {
        userForm.reset();
        document.getElementById('userUid').value = '';
        document.getElementById('userRole').value = 'user';
        document.getElementById('userPasswordGroup').style.display = 'block';
    }

    function showSweetAlert(message, type) {
        Swal.fire({
            title: type === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
            text: message,
            icon: type,
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            customClass: {
                popup: 'sweet-alert-popup'
            }
        });
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatThaiDate(date) {
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear() + 543;
        return `${day}/${month}/${year}`;
    }

    function getCarName(carId) {
        if (carId === 'none') return '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏ñ';
        const car = cars.find(c => c.id === carId);
        return car ? (car.brand || car.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ') : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ';
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
            'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
            'rejected': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'
        };
        return statusMap[status] || status;
    }

    function getPurposeText(purpose) {
        const purposeMap = {
            'normal': '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ',
            'leaveWork': '‡∏ù‡∏≤‡∏Å‡∏á‡∏≤‡∏ô',
            'carToWork': '‡∏ï‡∏¥‡∏î‡∏£‡∏ñ‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô'
        };
        return purposeMap[purpose] || purpose;
    }


function showEditBookingModal(bookingId) {
    const booking = bookings.find(b => b.id === bookingId);
    if (booking) {
        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        viewBookingsModal.classList.remove('active');
        myBookingsModal.classList.remove('active');
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô
        resetBookingForm();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        showBookingFormFields();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        showBookingModal(null, booking);
    }
}

// ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addMileageActionButtons ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
function addMileageActionButtons(bookingItem, booking) {
    const isAdmin = currentUser.role === 'admin';
    const isOwner = booking.userId === currentUser.uid;
    const isPastOrToday = new Date(booking.startDate) <= new Date(formatDate(new Date())); // ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà:
    // - ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á)
    // - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á + ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const canRecordMileage = isAdmin || (isOwner && isPastOrToday);

    const hasMileageOut = booking.mileageOut && booking.mileageOut !== '';
    const hasMileageIn = booking.mileageIn && booking.mileageIn !== '';

    if (canRecordMileage) {
        const mileageActions = document.createElement('div');
        mileageActions.className = 'mileage-actions';
        mileageActions.style.marginTop = '10px';
        mileageActions.style.paddingTop = '10px';
        mileageActions.style.borderTop = '1px solid rgba(0,0,0,0.1)';

        let buttonText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå';
        let buttonClass = 'btn-warning';

        if (!hasMileageOut) {
            buttonText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å';
            buttonClass = 'btn-warning';
        } else if (!hasMileageIn) {
            buttonText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤';
            buttonClass = 'btn-secondary';
        } else {
            buttonText = '‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡∏•‡πå';
            buttonClass = 'btn-primary';
        }

        mileageActions.innerHTML = `
            <button class="btn btn-sm ${buttonClass}" onclick="showMileageForm('${booking.id}')">
                <i class="fas fa-tachometer-alt"></i> ${buttonText}
            </button>
        `;

        bookingItem.appendChild(mileageActions);
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ)
    if (hasMileageOut || hasMileageIn) {
        const mileageInfo = document.createElement('div');
        mileageInfo.className = 'mileage-info';
        mileageInfo.style.marginTop = '8px';
        mileageInfo.style.padding = '8px';
        mileageInfo.style.background = 'rgba(52, 199, 89, 0.1)';
        mileageInfo.style.borderRadius = '6px';
        mileageInfo.style.fontSize = '0.8rem';

        let infoHTML = '<strong><i class="fas fa-tachometer-alt"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå:</strong><br>';

        if (hasMileageOut) {
            infoHTML += `‡∏≠‡∏≠‡∏Å: ${booking.mileageOut} ‡∏Å‡∏°.`;
            if (booking.actualStartTime) infoHTML += ` (‡∏≠‡∏≠‡∏Å ${booking.actualStartTime})`;
            if (booking.mileageOutRecordedBy) infoHTML += ` ‡πÇ‡∏î‡∏¢ ${booking.mileageOutRecordedBy}`;
            infoHTML += '<br>';
        }

        if (hasMileageIn) {
            infoHTML += `‡πÄ‡∏Ç‡πâ‡∏≤: ${booking.mileageIn} ‡∏Å‡∏°.`;
            if (booking.actualEndTime) infoHTML += ` (‡πÄ‡∏Ç‡πâ‡∏≤ ${booking.actualEndTime})`;
            if (booking.mileageInRecordedBy) infoHTML += ` ‡πÇ‡∏î‡∏¢ ${booking.mileageInRecordedBy}`;
            const distance = parseInt(booking.mileageIn) - parseInt(booking.mileageOut);
            infoHTML += `<br><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°.</strong>`;
        } else if (hasMileageOut) {
            infoHTML += '‚è≥ ‡∏£‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤';
        }

        if (booking.mileageNotes) {
            infoHTML += `<br>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${booking.mileageNotes}`;
        }

        mileageInfo.innerHTML = infoHTML;
        bookingItem.appendChild(mileageInfo);
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå
function showMileageForm(bookingId) {
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) return;



    const isAdmin = currentUser.role === 'admin';
    const isOwner = booking.userId === currentUser.uid;
    const isPastOrToday = new Date(booking.startDate) <= new Date(formatDate(new Date()));
    const canRecord = isAdmin || (isOwner && isPastOrToday);

    if (!canRecord) {
        showSweetAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 'error');
        return;
    }
    
    // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    viewBookingsModal.classList.remove('active');
    myBookingsModal.classList.remove('active');
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
    resetBookingForm();
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('bookingId').value = bookingId;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    displayBookingInfo(booking);
    
    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (booking.actualStartTime) {
        document.getElementById('actualStartTime').value = booking.actualStartTime;
    }
    if (booking.actualEndTime) {
        document.getElementById('actualEndTime').value = booking.actualEndTime;
    }
    if (booking.mileageOut) {
        document.getElementById('mileageOut').value = booking.mileageOut;
    }
    if (booking.mileageIn) {
        document.getElementById('mileageIn').value = booking.mileageIn;
    }
    if (booking.mileageNotes) {
        document.getElementById('mileageNotes').value = booking.mileageNotes;
    }
    
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö required
    hideBookingFormFields();
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå
    document.getElementById('mileageSection').style.display = 'block';
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    setupMileageButton(booking);
    
    // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå)
    bookingModal.classList.add('active');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏ö required
function hideBookingFormFields() {
    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô
    const fieldsToHide = [
        'startDate', 'endDate', 'bookerName', 'department', 
        'purposeNormal', 'purposeLeaveWork', 'purposeCarToWork',
        'carSelectGroup', 'selfDrive', 'withDriver',
        'startTime', 'endTime', 'destination', 'notes', 'adminControls'
    ];
    
    fieldsToHide.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô radio group ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô container ‡πÅ‡∏•‡∏∞‡∏•‡∏ö required
            if (fieldId.includes('purpose') || fieldId.includes('Drive')) {
                const container = element.closest('.form-group');
                if (container) {
                    container.style.display = 'none';
                    // ‡∏•‡∏ö required ‡∏à‡∏≤‡∏Å radio buttons
                    container.querySelectorAll('input[required]').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            } else {
                element.style.display = 'none';
                // ‡∏•‡∏ö attribute required
                element.removeAttribute('required');
            }
        }
    });
    
    // ‡∏ã‡πà‡∏≠‡∏ô label ‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
    document.querySelectorAll('.form-label').forEach(label => {
        const forId = label.getAttribute('for');
        if (forId && fieldsToHide.includes(forId)) {
            label.style.display = 'none';
        }
    });
    
    // ‡∏ã‡πà‡∏≠‡∏ô form-group ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
    document.querySelectorAll('.form-group').forEach(group => {
        const visibleFields = group.querySelectorAll('input:not([style*="display: none"]), select:not([style*="display: none"]), textarea:not([style*="display: none"])');
        if (visibleFields.length === 0 && !group.querySelector('#mileageSection')) {
            group.style.display = 'none';
        }
    });
    
    // ‡∏•‡∏ö required ‡∏à‡∏≤‡∏Å carSelect ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    const carSelect = document.getElementById('carSelect');
    if (carSelect) {
        carSelect.removeAttribute('required');
    }
    
    // ‡∏•‡∏ö required ‡∏à‡∏≤‡∏Å radio buttons ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    document.querySelectorAll('input[type="radio"][required]').forEach(radio => {
        radio.removeAttribute('required');
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
function showBookingFormFields() {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    const fieldsToShow = [
        'startDate', 'endDate', 'bookerName', 'department', 
        'purposeNormal', 'purposeLeaveWork', 'purposeCarToWork',
        'carSelectGroup', 'selfDrive', 'withDriver',
        'startTime', 'endTime', 'destination', 'notes', 'adminControls'
    ];
    
    fieldsToShow.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.style.display = '';
            
            // ‡∏Ñ‡∏∑‡∏ô attribute required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (['startDate', 'endDate', 'startTime', 'endTime', 'destination'].includes(fieldId)) {
                element.setAttribute('required', 'required');
            }
        }
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á label ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
    document.querySelectorAll('.form-label').forEach(label => {
        label.style.display = 'block';
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á form-group ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
    document.querySelectorAll('.form-group').forEach(group => {
        group.style.display = 'block';
    });
    
    // ‡∏Ñ‡∏∑‡∏ô required ‡πÉ‡∏´‡πâ radio buttons
    document.querySelectorAll('input[name="driverStatus"]').forEach(radio => {
        radio.setAttribute('required', 'required');
    });
    
    // ‡∏Ñ‡∏∑‡∏ô required ‡πÉ‡∏´‡πâ carSelect ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    const purposeNormal = document.getElementById('purposeNormal');
    if (purposeNormal && purposeNormal.checked) {
        document.getElementById('carSelectGroup').style.display = 'block';
        const carSelect = document.getElementById('carSelect');
        if (carSelect) {
            carSelect.setAttribute('required', 'required');
        }
    } else {
        document.getElementById('carSelectGroup').style.display = 'none';
        const carSelect = document.getElementById('carSelect');
        if (carSelect) {
            carSelect.removeAttribute('required');
        }
    }
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á adminControls ‡∏ï‡∏≤‡∏° role
    if (currentUser.role === 'admin') {
        document.getElementById('adminControls').style.display = 'block';
    } else {
        document.getElementById('adminControls').style.display = 'none';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
function displayBookingInfo(booking) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    const bookingInfoSection = document.createElement('div');
    bookingInfoSection.className = 'booking-info-section';
    bookingInfoSection.innerHTML = `
        <h4 style="margin: 0 0 12px 0; color: var(--primary); display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </h4>
        <div style="background: rgba(0, 122, 255, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                    <input type="text" class="form-control" value="${booking.bookerName}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <input type="text" class="form-control" value="${booking.department}" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
                    <input type="text" class="form-control" value="${formatThaiDate(new Date(booking.startDate))}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
                    <input type="text" class="form-control" value="${formatThaiDate(new Date(booking.endDate))}" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                    <input type="text" class="form-control" value="${booking.startTime}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label>
                    <input type="text" class="form-control" value="${booking.endTime}" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</label>
                <input type="text" class="form-control" value="${getCarName(booking.carId)}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                <input type="text" class="form-control" value="${booking.destination}" readonly>
            </div>
            ${booking.notes ? `
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
                <textarea class="form-control" rows="2" readonly>${booking.notes}</textarea>
            </div>
            ` : ''}
        </div>
    `;
    
    // ‡πÅ‡∏ó‡∏£‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå
    const mileageSection = document.getElementById('mileageSection');
    mileageSection.parentNode.insertBefore(bookingInfoSection, mileageSection);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
function setupMileageButton(booking) {
    const hasMileageOut = booking.mileageOut && booking.mileageOut !== '';
    const hasMileageIn = booking.mileageIn && booking.mileageIn !== '';
    
    // ‡∏•‡∏ö required ‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    document.getElementById('mileageOut').removeAttribute('required');
    document.getElementById('mileageIn').removeAttribute('required');
    document.getElementById('actualStartTime').removeAttribute('required');
    document.getElementById('actualEndTime').removeAttribute('required');
    document.getElementById('mileageNotes').removeAttribute('required');
    
    if (!hasMileageOut) {
        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å
        document.getElementById('bookingModalTitle').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å';
        document.getElementById('saveBooking').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
        document.getElementById('mileageIn').closest('.form-group').style.display = 'none';
        document.getElementById('actualEndTime').closest('.form-group').style.display = 'none';
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        document.getElementById('mileageOut').setAttribute('required', 'required');
        
    } else if (hasMileageOut && !hasMileageIn) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤
        document.getElementById('bookingModalTitle').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤';
        document.getElementById('saveBooking').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
        document.getElementById('mileageOut').closest('.form-group').style.display = 'none';
        document.getElementById('actualStartTime').closest('.form-group').style.display = 'none';
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        document.getElementById('mileageIn').setAttribute('required', 'required');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å
        showMileageOutSummary(booking);
        
    } else {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        document.getElementById('bookingModalTitle').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤';
        document.getElementById('saveBooking').textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå';
        
        // ‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏î‡πÜ ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        showFullMileageSummary(booking);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å
function showMileageOutSummary(booking) {
    const summarySection = document.createElement('div');
    summarySection.className = 'mileage-out-summary';
    summarySection.innerHTML = `
        <div style="background: rgba(255, 149, 0, 0.1); padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--warning);">
            <strong><i class="fas fa-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß:</strong>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                ‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å: ${booking.mileageOut} 
                ${booking.actualStartTime ? `(‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á: ${booking.actualStartTime})` : ''}
                ${booking.mileageOutRecordedBy ? `- ‡πÇ‡∏î‡∏¢: ${booking.mileageOutRecordedBy}` : ''}
            </div>
        </div>
    `;
    
    const mileageSection = document.getElementById('mileageSection');
    mileageSection.parentNode.insertBefore(summarySection, mileageSection);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
function showFullMileageSummary(booking) {
    const distance = parseInt(booking.mileageIn) - parseInt(booking.mileageOut);
    
    const summarySection = document.createElement('div');
    summarySection.className = 'full-mileage-summary';
    summarySection.innerHTML = `
        <div style="background: rgba(52, 199, 89, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 3px solid var(--secondary);">
            <strong><i class="fas fa-chart-line"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong>
            <div style="font-size: 0.9rem; margin-top: 8px;">
                <div>‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å: ${booking.mileageOut} ${booking.actualStartTime ? `(‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á: ${booking.actualStartTime})` : ''}</div>
                <div>‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤: ${booking.mileageIn} ${booking.actualEndTime ? `(‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á: ${booking.actualEndTime})` : ''}</div>
                <div style="font-weight: 600; color: var(--accent); margin-top: 5px;">
                    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ${distance} ‡∏Å‡∏°.
                </div>
                ${booking.mileageNotes ? `<div style="margin-top: 5px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${booking.mileageNotes}</div>` : ''}
            </div>
        </div>
    `;
    
    const mileageSection = document.getElementById('mileageSection');
    mileageSection.parentNode.insertBefore(summarySection, mileageSection);
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå
function handleMileageRecording() {
    const bookingId = document.getElementById('bookingId').value;
    const booking = bookings.find(b => b.id === bookingId);
    if (!booking) return;

    const actualStartTime = document.getElementById('actualStartTime').value;
    const actualEndTime = document.getElementById('actualEndTime').value;
    const mileageOut = document.getElementById('mileageOut').value;
    const mileageIn = document.getElementById('mileageIn').value;
    const mileageNotes = document.getElementById('mileageNotes').value;

    const hasMileageOut = booking.mileageOut && booking.mileageOut !== '';
    const hasMileageIn = booking.mileageIn && booking.mileageIn !== '';

    let updateData = {};
    const recordedBy = currentUser.displayName || currentUser.email;
    const recordedAt = firebase.database.ServerValue.TIMESTAMP;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô
    if (!hasMileageOut) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å
        if (!mileageOut) {
            showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å', 'error');
            return;
        }
        if (mileageOut < 0) {
            showSweetAlert('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0', 'error');
            return;
        }

        updateData = {
            mileageOut: mileageOut,
            mileageOutRecordedBy: recordedBy,
            mileageOutRecordedAt: recordedAt,
            mileageNotes: mileageNotes || ''
        };

        if (actualStartTime) updateData.actualStartTime = actualStartTime;

    } else if (hasMileageOut && !hasMileageIn) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤
        if (!mileageIn) {
            showSweetAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤', 'error');
            return;
        }
        if (mileageIn < 0) {
            showSweetAlert('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0', 'error');
            return;
        }
        if (parseInt(mileageIn) <= parseInt(booking.mileageOut)) {
            showSweetAlert('‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å', 'error');
            return;
        }

        updateData = {
            mileageIn: mileageIn,
            mileageInRecordedBy: recordedBy,
            mileageInRecordedAt: recordedAt
        };

        if (actualEndTime) updateData.actualEndTime = actualEndTime;
        if (mileageNotes) updateData.mileageNotes = mileageNotes;

    } else {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        updateData = {};
        if (mileageOut) updateData.mileageOut = mileageOut;
        if (mileageIn) updateData.mileageIn = mileageIn;
        if (actualStartTime) updateData.actualStartTime = actualStartTime;
        if (actualEndTime) updateData.actualEndTime = actualEndTime;
        if (mileageNotes !== undefined) updateData.mileageNotes = mileageNotes;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
        if (mileageOut && mileageIn && parseInt(mileageIn) <= parseInt(mileageOut)) {
            showSweetAlert('‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å', 'error');
            return;
        }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    database.ref('bookings/' + bookingId).update(updateData)
        .then(() => {
            bookingModal.classList.remove('active');
            
            let successMessage = '';
            if (!hasMileageOut) {
                successMessage = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else if (hasMileageOut && !hasMileageIn) {
                successMessage = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else {
                successMessage = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            }
            
            showSweetAlert(successMessage, 'success');
            resetMileageForm();
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            setTimeout(() => {
                if (selectedDate) {
                    showViewBookingsModal(selectedDate);
                }
                updateMyTodayBookings();
            }, 500);
        })
        .catch((error) => {
            showSweetAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        });
}

// ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå
function resetMileageForm() {
    // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    const bookingInfoSection = document.querySelector('.booking-info-section');
    if (bookingInfoSection) {
        bookingInfoSection.remove();
    }
    
    // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡∏•‡πå
    const mileageSummary = document.querySelector('.mileage-out-summary, .full-mileage-summary');
    if (mileageSummary) {
        mileageSummary.remove();
    }
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡∏•‡πå
    document.getElementById('mileageSection').style.display = 'none';
    document.getElementById('actualStartTime').value = '';
    document.getElementById('actualEndTime').value = '';
    document.getElementById('mileageOut').value = '';
    document.getElementById('mileageIn').value = '';
    document.getElementById('mileageNotes').value = '';
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô required
    showBookingFormFields();
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    document.querySelectorAll('#mileageSection .form-group').forEach(el => {
        el.style.display = 'block';
    });
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    document.getElementById('bookingModalTitle').textContent = '‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå';
    document.getElementById('saveBooking').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
}
    document.addEventListener('DOMContentLoaded', initApp);



</script>
</body>
</html>
